/*
 * Statebot
 * v2.6.0
 * https://shuckster.github.io/statebot/
 * License: MIT
 */
"use strict";function t(t){return{all:t=t||new Map,on:function(n,e){var r=t.get(n);r&&r.push(e)||t.set(n,[e])},off:function(n,e){var r=t.get(n);r&&r.splice(r.indexOf(e)>>>0,1)},emit:function(n,e){(t.get(n)||[]).slice().map((function(t){t(e)})),(t.get("*")||[]).slice().map((function(t){t(n,e)}))}}}function n(t){return Array.isArray(t)}function e(t){return"function"==typeof t}function r(t){return"string"==typeof t}function o(t){return"object"==typeof t}function i(t){return!(null===t||!o(t))&&Object.getPrototypeOf(t)===Object.prototype}function s(t){return!!r(t)||!!n(t)&&t.every(r)}function c(t){return t.reduce(((t,n)=>-1===t.indexOf(n)?[...t,n]:t),[])}function a(t){return(...n)=>(function(t,...n){const e=setTimeout(t,0,...n);return()=>clearTimeout(e)})(t,...n)}function u(t){let n,e=!1;return{fn:(...r)=>(e||(n=t(...r)),n),revoke:()=>{e=!0}}}function f(t,n,e,...r){const o=[...r].flat().reduce(((t,n)=>({...t,[n]:0})),{});function i(t){const n=s(t)-1;o[t]=Math.max(n,0)}function s(t){return o[t]||0}return{increase:function(t){return o[t]=s(t)+1,()=>i(t)},decrease:i,countOf:s,toValue:function(){return{description:`Statebot[${t}]: ${e}:`,table:Object.keys(o).sort().map((t=>[t,o[t]])).map((([t,e])=>({[n]:t,refs:e||"None"})))}},refs:function(){return{...o}}}}Object.defineProperty(exports,"__esModule",{value:!0});function l(t=""){return function(n,r,...o){const i=Object.keys(r).join(", "),s=Object.entries(r).map((([t,n])=>({argName:t,argType:n}))),c=o.map(((...t)=>((t,n,r)=>{const{argName:o,argType:i}=t[r];if(void 0===n)return`Argument undefined: "${o}"`;const s=e(i)?((t,n,e)=>n(e)?void 0:`${n.name}(${t}) did not return true`)(o,i,n):((t,n,e)=>typeof e===n?void 0:`Argument "${t}" should be a ${n}`)(o,i,n);return s?`${s}: ${o} === ${typeof n}(${n})`:void 0})(s,...t))).filter(Boolean);if(c.length)return`\n${t}${n}(${i}):\n${c.map((t=>`> ${t}`)).join("\n")}`}}function p(t,n=console){let e=t;function o(){return e>=1}function i(){return e>=2}function s(){return e>=3}return r(e)&&(e={info:3,log:2,warn:1,none:0}[e]||3),{canWarn:o,canLog:i,canInfo:s,info:(...t)=>s()&&n.info(...t),table:(...t)=>i()&&n.table(...t),log:(...t)=>i()&&n.log(...t),warn:(...t)=>o()&&n.warn(...t),error:(...t)=>n.error(...t)}}const h=/[\r\n]/,m="|",d="->",$=[m,d].map((t=>t.replace("|","\\|"))).join("|"),g=new RegExp(`(${$})$`),w=/[^a-z0-9!@#$%^&*:_+=<>|~.\x2D]/gi,E=/(\/\/[^\n\r]*)/,v=l("statebot.");function T(t){const n=v("decomposeRoute",{templateLiteral:s},t);if(n)throw TypeError(n);return S(y(t)).flat(2)}function b(t){const n=v("decomposeChart",{chart:s},t);if(n)throw TypeError(n);const e=S(y(t)),r=e.map(O).flat(1).map(x).flat(1);let o=!1;const i=c(r.map((t=>(t.includes("")&&(o=!0),t.join(d))))),a=c(e.flat(3));return{transitions:i.map((t=>t.split(d))),routes:i,states:o?a:a.filter(Boolean)}}function y(t){const n=(function(t){return[t].flat().reduce(((t,n)=>[...t,n.split(h)]),[]).flat()})(t),e=[];let r=!1;const o=n.reduce(((t,n)=>{const o=n.replace(E,"").replace(w,"");return o?(r=g.test(o),r?t+o:(e.push(t+o),"")):t}),"");return r||o?[...e,o]:[...e]}function S(t){return t.map((t=>t.split(d).map((t=>t.split(m)))))}function O(t){const n=[];return t.reduce(((t,e)=>(!1===t||n.push([t,[...e]]),[...e])),!1),n}function x([t,n]){return t.reduce(((t,e)=>[...t,...n.map((t=>[e,t]))]),[])}const A="onExiting",I="onEntering",j="onExited",L="onEntered",N="onSwitching",C="onSwitched",P={[N]:"(ANY)state:changing",[C]:"(ANY)state:changed"};function _(t,n){const e=[],r=[];return{configs:t.reduce(((t,o)=>{const{routeChart:i,action:s}=o,{states:c,routes:a,transitions:u}=b(i);return n()&&(e.push(...c),r.push(...a)),[...t,...u.map((([t,n])=>({fromState:t,toState:n,action:s})))]}),[]),states:e,routes:r}}function k(t){return i(t)&&"number"==typeof t.__STATEBOT__}function R(t){const n=t.addListener?(...n)=>t.addListener(...n):(...n)=>t.on(...n),e=t.removeListener?(...n)=>t.removeListener(...n):(...n)=>t.off(...n),r=new Map;return{emit:(n,...e)=>t.emit(n,e),on:function(t,e){let o=r.get(e);o||(o={handleEvent:(t=[])=>e(...t),refCount:0},r.set(e,o)),o.refCount+=1,n(t,o.handleEvent)},off:function(t,n){let o=r.get(n);o&&(e(t,o.handleEvent),o.refCount-=1,0===o.refCount&&r.delete(n))}}}const M=l("statebot.");let D=0;function F(){const t=Date.now();function n(t,n){return t.toFixed(n).replace(/\.0+$/,"")}return function(){const e=Date.now()-t;return e<500?`${n(e)} ms`:e<5e3?`${n(e/1e3,2)} s `:e<6e4?`${n(e/1e3,1)} s `:`${n(e/1e3/60,1)} m `}}exports.Statebot=function(s,c){if(!r(s))throw new TypeError("\nStatebot: Please specify a name for this machine");const a=`Statebot[${s}]`;if(!i(c))throw new TypeError(`\n${a}: Please specify options for this machine`);const{chart:u,logLevel:h=3,historyLimit:m=2}=c||{},$=void 0===c.events?R(t()):o(g=c.events)&&e(g.emit)&&(e(g.addListener)||e(g.on))&&(e(g.removeListener)||e(g.off))&&R(c.events);var g;if(!$)throw new TypeError(`\n${a}: Invalid event-emitter specified in options`);const{states:w=[],routes:E=[]}=u?b(u):c,{startIn:v=w[0]}=c;if(!w.includes(v))throw new Error(`${a}: Starting-state not in chart: "${v}"`);const T=l(`${a}#`),y=p(h,console),{canWarn:S}=y,O=[v],x=Math.max(m,2),k=R(t());let M=0;const{pause:D,resume:F,paused:B,Pausable:Y}=(function(t=!1,n=(()=>{})){let e=!!t;return{Pausable:function(t){return(...r)=>e?(n(),!1):t(...r)},paused:()=>e,pause:()=>{e=!0},resume:()=>{e=!1}}})(!1,(()=>y.warn(`${a}: Ignoring callback, paused`))),G=Y(((t,...n)=>k.emit(t,...n)));function H(t,n){return k.on(t,n),()=>k.off(t,n)}const U=f(s,"states","Listening for the following state-changes",[...w]),V=f(s,"transitions","Listening for the following transitions",[...E]),W=f(s,"events","Listening for the following events");function z(t,o){const c=e(t)?t({enter:Z,emit:X,Enter:ot,Emit:rt}):i(t)?t:null;if(!i(c))throw new TypeError(`Statebot[${s}]#${o}(): Expected an object, or a function that returns an object`);const{transitionsForEvents:a,transitionsOnly:u}=(function(t){const o={},s=[];return Object.entries(t).map((([t,c])=>{if(e(c))return void s.push({routeChart:t,action:c});if(!i(c))return;const{on:a,then:u}=c;if(r(a)||n(a)){[a].flat().map((n=>{o[n]=o[n]||[],o[n].push({routeChart:t,action:u})}))}else e(u)&&s.push({routeChart:t,action:c})})),{transitionsForEvents:o,transitionsOnly:s}})(c),f=[],l=[],p=[],h=Object.entries(a).reduce(((t,[n,e])=>{const{states:r,routes:o,configs:i}=_(e,S);return S()&&(f.push(...r),l.push(...o)),{...t,[n]:i}}),{});function m({fromState:t,toState:n,action:r,args:o}){return Q(t,(()=>(Z(n,...o),e(r)&&r(...o),!0)))}p.push(...Object.entries(h).map((function([t,n]){return[W.increase(t),tt(t,((...e)=>{n.map((t=>({...t,args:e}))).some(m)||it(`Event not handled: "${t}"`)}))]})).flat());const d=_(u,S);if(S()&&(f.push(...d.states),l.push(...d.routes)),p.push(...d.configs.map((function(t){const{fromState:n,toState:e,action:r}=t,o=`${n}->${e}`;return[V.increase(o),H(o,r)]})).flat()),S()){const t=f.filter((t=>!w.includes(t))),n=l.filter((t=>!E.includes(t)));t.length&&y.warn(`Statebot[${s}]#${o}(): Invalid states specified:\n`+t.map((t=>`  > "${t}"`)).join("\n")),n.length&&y.warn(`Statebot[${s}]#${o}(): Invalid transitions specified:\n`+n.map((t=>`  > "${t}"`)).join("\n"))}return()=>p.map((t=>t()))}function K(){return O[O.length-2]}function q(){return O[O.length-1]}function J(t){const n=void 0!==t?t:q(),e=T("statesAvailableFromHere",{state:r},n);if(e)throw new TypeError(e);return E.reduce(((t,e)=>{const[r,o]=e.split(d).map((t=>t.trim()));return r===n?[...t,o]:t}),[])}function Q(t,n,...o){const i=T("inState",{state:r},t);if(i)throw new TypeError(i);const s=q()===t;return void 0===n?s:s?e(n)?n(...o):n:null}const X=Y(((t,...n)=>{const e=T("emit",{eventName:r},t);if(e)throw new TypeError(e);return $.emit(t,...n)})),Z=Y(((t,...n)=>{const e=T("enter",{state:r},t);if(e)throw new TypeError(e);const o=q(),i=t;if(i===o)return it(`Already in state: "${i}"`),!1;if(!w.includes(i))return it(`Invalid state "${i}", not switching`),!1;const s=`${o}->${i}`;return E.includes(s)?(y.info(`${a}: tId<${++M}>: ${s}`),O.push(i),O.length>x&&O.shift(),G(P[N],i,o,...n),G(s,...n),G(P[C],i,o,...n),!0):(it(`Invalid transition "${s}", not switching`),!1)}));function tt(t,n){const o=T("onEvent",{eventName:r,cb:e},t,n);if(o)throw new TypeError(o);return $.on(t,n),()=>$.off(t,n)}const nt=Object.keys(P).reduce(((t,n)=>({...t,[n]:t=>{const r=T(n,{cb:e},t);if(r)throw new TypeError(r);const o=U.increase(P[n]),i=H(P[n],t);return()=>{i(),o()}}})),{}),et=[[A,N],[I,N],[j,C],[L,C]].reduce(((t,n)=>{const[o,i]=n,s=o.slice(2),c=s.toLowerCase();return{...t,[o]:(t,n)=>{const a=T(o,{state:r,cb:e},t,n);if(a)throw new TypeError(a);const u=[U.increase(t),U.increase(`${t}:${c}`)],f=nt[i](((e,r,...o)=>{0===s.indexOf("Exit")?t===r&&n(e,...o):t===e&&n(r,...o)}));return()=>{f(),u.map((t=>t()))}}}}),{});function rt(t,...n){const e=T("Emit",{eventName:r},t);if(e)throw new TypeError(e);return(...e)=>X(t,...n,...e)}function ot(t,...n){const e=T("Enter",{state:r},t);if(e)throw new TypeError(e);return(...e)=>Z(t,...n,...e)}function it(t){const n=K(),e=q(),r=`${void 0===n?"[undefined]":n}->${e}`,o=J();o.length?y.info(`${a}: ${t}\n  > Previous transition: "${r}"\n  > From "${e}", valid states are: [${o.map((t=>`"${t}"`)).join(", ")}]`):y.info(`${a}: ${t}\n  > Previous transition: "${r}"\n  > There are no states available from "${e}"`)}function st(t){const{description:n,table:e}=t.toValue();y.log(n),e.length?y.table(e):y.log("  > No information")}return{__STATEBOT__:1,canTransitionTo:function(...t){const n=t.flat(),e=T("canTransitionTo",{state:r},n[0]);if(e)throw new TypeError(e);if(!n.length)return!1;const o=J();return n.every((t=>o.includes(t)))},currentState:q,emit:X,Emit:rt,enter:Z,Enter:ot,history:()=>[...O],info:()=>(y.log(`${a}: Information about this state-machine`),st(U),st(V),void st(W)),inspect:()=>({states:U.refs(),transitions:V.refs(),events:W.refs()}),inState:Q,InState:function(t,n,...e){const o=T("InState",{state:r},t);if(o)throw new TypeError(o);return(...r)=>Q(t,n,...e.concat(r))},name:()=>s,onEntered:et[L],onEntering:et[I],onEvent:tt,onExited:et[j],onExiting:et[A],onSwitched:nt[C],onSwitching:nt[N],onTransitions:t=>z(t,"onTransitions"),pause:D,paused:B,performTransitions:t=>z(t,"performTransitions"),previousState:K,reset:function(){y.warn(`${a}: State-machine reset!`),O.length=0,O.push(v)},resume:F,statesAvailableFromHere:J}},exports.assertRoute=function(t,n,e){const r=M("assertRoute",{machine:k,expectedRoute:s},t,n);if(r)throw TypeError(r);D+=1;const{description:o="Assertion complete",fromState:i="",run:c=(()=>{}),permittedDeviations:f=0,timeoutInMs:l=1e3,logLevel:h=3}=e||{},m=p(h),d=`Statebot[${t.name()}]: aId<${D}>`,$=T(n);m.log(`\n${d}: Asserting route: [${$.join(" > ")}]`),m.log(`${d}: > Assertion will start from state: "${i}"`);const g=a(c);let w=()=>{};const E=F();let v,b=F(),y=0,S=!0,O=!1;const x=[...$],A=(function(t=[],n=[]){const e=[],r=t.map(((t,e)=>n[e]||"center"));let o=!1;function i(){o=!0}function s(...n){if(o)return;const r=t.reduce(((t,e,r)=>({...t,[e]:n[r]||""})),{});e.push(r)}function c(){return e.reduce(((n,e)=>t.map(((t,r)=>Math.max(e[t].length,n[r])))),t.map((()=>0)))}function a(t,n){return t+" ".repeat(n-t.length)}function u(t,n){return" ".repeat(n-t.length)+t}function f(){const n=c();function o(t,e){const o=n[e],i=r[e];return"left"===i?a(t,o):"right"===i?u(t,o):t}return e.reduce(((n,e)=>[...n,t.reduce(((t,n,r)=>({...t,[n]:o(e[n],r)})),{})]),[])}return{lock:i,addRow:s,content:f}})(["state","expected","info","took"],["center","center","left","right"]),I=(function(t){const{revoke:n,fn:e}=u(t);let r;return function(...t){return r=e(...t),n(),r}})((t=>(j("","","","TOTAL: "+E()),A.lock(),m.log(`\n${d}: ${o}: [${t?"FAILED":"SUCCESS"}]`),m.table(A.content()),t))),{addRow:j}=A;return new Promise(((n,e)=>{if(0===x.length)return void e(I(new Error("NO ROUTE TO TEST")));const r=n=>{for(;x.length;){const e=x.shift();j(t.currentState(),`(${e})`,n),O=!1}(t=>{clearTimeout(v),w(),c(),e(t)})(I(new Error(n)))};t.inState(i)&&(S=!1,w=g());const{revoke:o,fn:s}=u((t=>{v=setTimeout((()=>{o(),r("TIMEOUT")}),l),(function(t){if(S)j(t,"-","PENDING");else{const n=x[0];n===t?(j(t,n,O?"REALIGNED":"OKAY",b()),O=!1,x.shift()):(j(t,n,"WRONG STATE",b()),O=!0,y+=1),b=F()}})(t),S&&t===i&&(S=!1,w=g()),y>f&&(o(),r("TOO MANY DEVIATIONS")),x.length<=0&&(o(),((...t)=>{clearTimeout(v),w(),c(),n(...t)})(I()))})),c=t.onSwitching(s)}))},exports.decomposeChart=b,exports.isStatebot=k,exports.routeIsPossible=function(t,n){const e=M("routeIsPossible",{machine:k,route:s},t,n);if(e)throw TypeError(e);const r=T(n);return r.every(((n,e)=>{if(e===r.length-1)return!0;{const o=r[e+1];return t.statesAvailableFromHere(n).includes(o)}}))};
