!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.statebot=e():t.statebot=e()}(window,(function(){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(r,o,function(e){return t[e]}.bind(null,o));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=3)}([function(t,e){function n(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var n=[],r=!0,o=!1,i=void 0;try{for(var a,c=t[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{r||null==c.return||c.return()}finally{if(o)throw i}}return n}(t,e)||c(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function o(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){i(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function i(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function a(t){return function(t){if(Array.isArray(t))return u(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||c(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(t,e){if(t){if("string"==typeof t)return u(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(t,e):void 0}}function u(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function f(t){return(f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function s(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];var o=setTimeout.apply(void 0,[t,0].concat(n));return function(){clearTimeout(o)}}function l(t){var e,n=!1;return{fn:function(){return n||(e=t.apply(void 0,arguments)),e},revoke:function(){n=!0}}}t.exports={isEventEmitter:function(t){return"object"===f(t)&&"function"==typeof t.emit&&"function"==typeof t.addListener&&"function"==typeof t.removeListener},isPojo:function(t){if(null===t||"object"!==f(t))return!1;return Object.getPrototypeOf(t)===Object.prototype},isTemplateLiteral:function(t){if("string"==typeof t)return!0;if(Array.isArray(t))return t.every((function(t){return"string"==typeof t}));return!1},uniq:function(t){return t.reduce((function(t,e){return-1===t.indexOf(e)?[].concat(a(t),[e]):t}),[])},Defer:function(t){return function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return s.apply(void 0,[t].concat(n))}},Once:function(t){var e,n=l(t),r=n.revoke,o=n.fn;return function(){return e=o.apply(void 0,arguments),r(),e}},Revokable:l,ReferenceCounter:function(t,e,r){for(var a={},c=arguments.length,u=new Array(c>3?c-3:0),f=3;f<c;f++)u[f-3]=arguments[f];function s(t){return a[t]=p(t)+1,function(){return l(t)}}function l(t){var e=p(t)-1;a[t]=Math.max(e,0)}function p(t){return a[t]||0}function v(){return o({},a)}function y(){return Object.keys(a).sort().map((function(t){return[t,a[t]]})).map((function(t){var r,o=n(t,2),a=o[0],c=o[1];return i(r={},e,a),i(r,"refs",c||"None"),r}))}function h(){return{description:"Statebot[".concat(t,"]: ").concat(r,":"),table:y()}}return[].concat(u).flat().forEach((function(t){a[t]=0})),{increase:s,decrease:l,countOf:p,toValue:h,refs:v}},ArgTypeError:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return function(e,r){for(var o=Object.entries(r).map((function(t){var e=n(t,2);return{argName:e[0],argType:e[1]}})),i=Object.keys(r).join(", "),a=arguments.length,c=new Array(a>2?a-2:0),u=2;u<a;u++)c[u-2]=arguments[u];var s=c.map((function(t,e){var n,r,i,a=o[e],c=a.argName,u=a.argType;return void 0===t?'Argument undefined: "'.concat(c,'"'):("function"==typeof u?(i=!0===u(t),r=u.name,n="".concat(r,"(").concat(c,") did not return true")):(i=f(t)===u,r=u,n='Argument "'.concat(c,'" should be a ').concat(r)),i?void 0:"".concat(n,": ").concat(c," === ").concat(f(t),"(").concat(t,")"))})).filter(Boolean);return s.length?"\n".concat(t).concat(e,"(").concat(i,"):\n")+"".concat(s.map((function(t){return"> ".concat(t)})).join("\n")):void 0}},Logger:function(t){var e=t;"string"==typeof e&&(e={info:3,log:2,warn:1,none:0}[e]||3);function n(){return e>=1}function r(){return e>=2}function o(){return e>=3}return{canWarn:n,canLog:r,canInfo:o,info:function(){var t;return o()&&(t=console).info.apply(t,arguments)},table:function(){var t;return r()&&(t=console).table.apply(t,arguments)},log:function(){var t;return r()&&(t=console).log.apply(t,arguments)},warn:function(){var t;return n()&&(t=console).warn.apply(t,arguments)},error:function(){var t;return(t=console).error.apply(t,arguments)}}}}},function(t,e,n){function r(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var n=[],r=!0,o=!1,i=void 0;try{for(var a,c=t[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{r||null==c.return||c.return()}finally{if(o)throw i}}return n}(t,e)||i(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t){return function(t){if(Array.isArray(t))return a(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||i(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(t,e){if(t){if("string"==typeof t)return a(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?a(t,e):void 0}}function a(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var c="|",u="->",f=/[^a-z0-9!@#$%^&*:\-_+=<>|~\\.ยง]/gi,s=/[\r\n]/,l=/(\/\/[^\n\r]*)/,p=[c,u].map((function(t){return t.replace("|","\\|")})).join("|"),v=new RegExp("(".concat(p,")$"));t.exports={cxPipe:c,cxArrow:u,rxDisallowedCharacters:f,decomposeChart:function(t){var e=b("decomposeChart",{templateLiteral:m},t);if(e)throw TypeError(e);var n=O(w(g([t].flat()))).map(E).flat(1).map(S).flat(1),r=[],i=n.map((function(t){return r.push.apply(r,o(t)),t.join(u)})),a=h(i),c=h(r);return{transitions:a.map((function(t){return t.split(u)})),routes:a,states:c}},decomposeRoute:function(t){var e=b("decomposeRoute",{templateLiteral:m},t);if(e)throw TypeError(e);return O(w(g([t].flat()))).flat(2)}};var y=n(0),h=y.uniq,d=y.ArgTypeError,m=y.isTemplateLiteral,b=d("statebot.");function g(t){return t.reduce((function(t,e){return"string"!=typeof e?t:[].concat(o(t),o(e.split(s).map((function(t){return t.replace(l,"")}))))}),[]).filter(Boolean)}function w(t){return t.reduce((function(t,e){return v.test(e.trim())?{lines:t.lines,currentLine:t.currentLine+e}:{lines:[].concat(o(t.lines),[t.currentLine+e]),currentLine:""}}),{lines:[],currentLine:""}).lines}function O(t){return t.map((function(t){return t.split(u).map((function(t){return t.replace(f,"").split(c).map((function(t){return t.trim()}))}))}))}function E(t){return t.reduce((function(t,e){return!1===t?{previousStates:o(e),pairs:[]}:{previousStates:o(e),pairs:[].concat(o(t.pairs),[[o(t.previousStates),o(e)]])}}),!1).pairs}function S(t){var e=r(t,2),n=e[0],i=e[1];return n.reduce((function(t,e){return[].concat(o(t),o(i.map((function(t){return[e,t]}))))}),[])}},function(t,e,n){function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var n=[],r=!0,o=!1,i=void 0;try{for(var a,c=t[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{r||null==c.return||c.return()}finally{if(o)throw i}}return n}(t,e)||c(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(t){return function(t){if(Array.isArray(t))return u(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||c(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(t,e){if(t){if("string"==typeof t)return u(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(t,e):void 0}}function u(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}t.exports={Statebot:function(t,e){if("string"!=typeof t)throw TypeError("\nStatebot: Please specify a name for this machine");var n="Statebot[".concat(t,"]");if(!l(e))throw TypeError("\n".concat(n,": Please specify options for this machine"));var c=e||{},u=c.chart,s=void 0===u?void 0:u,d=c.logLevel,g=void 0===d?3:d,w=c.historyLimit,O=void 0===w?2:w,E=p("".concat(n,"#")),S=v(g),A=S.canWarn,j=s?m(s):e,T=j.states,L=void 0===T?[]:T,_=j.routes,x=void 0===_?[]:_,P=e.startIn;void 0===P&&(P=L[0]);if(!L.includes(P))throw Error("".concat(n,': Starting-state not in chart: "').concat(P,'"'));var I=0,C=[P],N=Math.max(O,2),D=y(e.events)?e.events:new f,R=new f,M={STATE_CHANGING:"(ANY)state:changing",STATE_CHANGED:"(ANY)state:changed"};function k(t){var e=E("emitInternalEvent",{eventName:"string"},t);if(e)throw TypeError(e);for(var n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return R.emit.apply(R,[t].concat(r))}function G(t,e){var n=E("onInternalEvent",{eventName:"string",fn:"function"},t,e);if(n)throw TypeError(n);return R.addListener(t,e),function(){R.removeListener(t,e)}}var F=h(t,"states","Listening for the following state-changes",a(L)),H=h(t,"transitions","Listening for the following transitions",a(x)),U=h(t,"events","Listening for the following events");function $(e,n){var c="function"==typeof e?e({enter:Q,emit:z,Enter:J,Emit:q}):l(e)?e:null;if(!l(c))throw TypeError("Statebot[".concat(t,"]#").concat(n,"(): Expected an object, or a function that returns an object"));var u={},f=[];Object.entries(c).forEach((function(t){var e=i(t,2),n=e[0],r=e[1];if("function"==typeof r)f.push({routeChart:n,action:r});else if(!l(r))return;var o=r.on,a=r.then;"string"==typeof o||Array.isArray(o)?[o].flat().forEach((function(t){u[t]=u[t]||[],u[t].push({routeChart:n,action:a})})):"function"==typeof a&&f.push({routeChart:n,action:r})}));var s=[],p=[],v=Object.entries(u).reduce((function(t,e){var n=i(e,2),c=n[0],u=B(n[1]),f=u.states,l=u.routes,v=u.configs;return A()&&(s.push.apply(s,a(f)),p.push.apply(p,a(l))),function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){o(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}({},t,o({},c,v))}),{}),y=[];y.push.apply(y,a(Object.entries(v).map((function(t){var e=i(t,2),n=e[0],r=e[1];return[U.increase(n),X(n,(function(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];var i=r.some((function(t){var n=t.fromState,r=t.toState,o=t.action;return!!K(n,(function(){return Q.apply(void 0,[r].concat(e)),"function"==typeof o&&o.apply(void 0,e),!0}))}));i||et('Event not handled: "'.concat(n,'"'))}))]})).flat()));var h=B(f);if(A()&&(s.push.apply(s,a(h.states)),p.push.apply(p,a(h.routes))),y.push.apply(y,a(h.configs.map((function(t){var e=t.fromState,n=t.toState,r=t.action,o="".concat(e,"->").concat(n);return[H.increase(o),G(o,r)]})).flat())),A()){var d=s.filter((function(t){return!L.includes(t)})),m=p.filter((function(t){return!x.includes(t)}));d.length&&S.warn("Statebot[".concat(t,"]#").concat(n,"(): Invalid states specified:\n")+d.map((function(t){return'  > "'.concat(t,'"')})).join("\n")),m.length&&S.warn("Statebot[".concat(t,"]#").concat(n,"(): Invalid transitions specified:\n")+m.map((function(t){return'  > "'.concat(t,'"')})).join("\n"))}return function(){return y.forEach((function(t){return t()}))}}function B(t){var e=[],n=[];return{configs:t.reduce((function(t,r){var o=r.routeChart,c=r.action,u=m(o),f=u.states,s=u.routes,l=u.transitions;return A()&&(e.push.apply(e,a(f)),n.push.apply(n,a(s))),[].concat(a(t),a(l.map((function(t){var e=i(t,2);return{fromState:e[0],toState:e[1],action:c}}))))}),[]),states:e,routes:n}}function W(){return C[C.length-2]}function Y(){return C[C.length-1]}function K(t,e){var n=E("inState",{state:"string"},t);if(n)throw TypeError(n);var r=Y()===t;if(void 0!==e){if(!r)return null;if("function"==typeof e){for(var o=arguments.length,i=new Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];return e.apply(void 0,i)}return e}return r}function V(t){var e=void 0!==t?t:Y(),n=E("statesAvailableFromHere",{state:"string"},e);if(n)throw TypeError(n);return x.reduce((function(t,n){var r=i(n.split(b).map((function(t){return t.trim()})),2),o=r[0],c=r[1];return o===e?[].concat(a(t),[c]):t}),[])}function q(t){var e=E("Emit",{eventName:"string"},t);if(e)throw TypeError(e);return function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return z.apply(void 0,[t].concat(n))}}function z(t){var e=E("emit",{eventName:"string"},t);if(e)throw TypeError(e);for(var n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return D.emit.apply(D,[t].concat(r))}function J(t){var e=E("Enter",{state:"string"},t);if(e)throw TypeError(e);return function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return Q.apply(void 0,[t].concat(n))}}function Q(t){var e=E("enter",{state:"string"},t);if(e)throw TypeError(e);var r=Y(),o=t;if(o===r)return et('Already in state: "'.concat(o,'"')),!1;if(!L.includes(o))return et('Invalid state "'.concat(o,'", not switching')),!1;var i="".concat(r,"->").concat(o);if(!x.includes(i))return et('Invalid transition "'.concat(i,'", not switching')),!1;S.info("".concat(n,": tId<").concat(++I,">: ").concat(i)),C.push(o),C.length>N&&C.shift();for(var a=arguments.length,c=new Array(a>1?a-1:0),u=1;u<a;u++)c[u-1]=arguments[u];return k.apply(void 0,[M.STATE_CHANGING,o,r].concat(c)),k.apply(void 0,[i].concat(c)),k.apply(void 0,[M.STATE_CHANGED,o,r].concat(c)),!0}function X(t,e){var n=E("onEvent",{eventName:"string",cb:"function"},t,e);if(n)throw TypeError(n);return D.addListener(t,e),function(){D.removeListener(t,e)}}function Z(t){var e=E("onSwitching",{cb:"function"},t);if(e)throw TypeError(e);var n=F.increase(M.STATE_CHANGING),r=G(M.STATE_CHANGING,(function(e,n){for(var r=arguments.length,o=new Array(r>2?r-2:0),i=2;i<r;i++)o[i-2]=arguments[i];t.apply(void 0,[e,n].concat(o))}));return function(){r(),n()}}function tt(t){var e=E("onSwitched",{cb:"function"},t);if(e)throw TypeError(e);var n=F.increase(M.STATE_CHANGED),r=G(M.STATE_CHANGED,(function(e,n){for(var r=arguments.length,o=new Array(r>2?r-2:0),i=2;i<r;i++)o[i-2]=arguments[i];t.apply(void 0,[e,n].concat(o))}));return function(){r(),n()}}function et(t){var e=W(),r=Y(),o="".concat(void 0===e?"[undefined]":e,"->").concat(r),i=V();i.length?S.info("".concat(n,": ").concat(t,"\n")+'  > Previous transition: "'.concat(o,'"\n')+'  > From "'.concat(r,'", valid states are: [').concat(i.map((function(t){return'"'.concat(t,'"')})).join(", "),"]")):S.info("".concat(n,": ").concat(t,"\n")+'  > Previous transition: "'.concat(o,'"\n')+'  > There are no states available from "'.concat(r,'"'))}function nt(t){var e=t.toValue(),n=e.description,r=e.table;S.log(n),r.length?S.table(r):S.log("  > No information")}return{__STATEBOT__:1,canTransitionTo:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var r=e.flat(),o=E("canTransitionTo",{state:"string"},r[0]);if(o)throw TypeError(o);if(!r.length)return!1;var i=V();return r.every((function(t){return i.includes(t)}))},currentState:Y,emit:z,Emit:q,enter:Q,Enter:J,history:function(){return[].concat(C)},info:function(){return S.log("".concat(n,": Information about this state-machine")),nt(F),nt(H),void nt(U)},inspect:function(){return{states:F.refs(),transitions:H.refs(),events:U.refs()}},inState:K,InState:function(t,e){var n=E("InState",{state:"string"},t);if(n)throw TypeError(n);return function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];return K.apply(void 0,[t,e].concat(r))}},name:function(){return t},onEntered:function(t,e){var n=E("onEntered",{state:"string",cb:"function"},t,e);if(n)throw TypeError(n);var r=[F.increase(t),F.increase("".concat(t,":entered"))],o=tt((function(n,r){if(t===n){for(var o=arguments.length,i=new Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];e.apply(void 0,[r].concat(i))}}));return function(){o(),r.map((function(t){return t()}))}},onEntering:function(t,e){var n=E("onEntering",{state:"string",cb:"function"},t,e);if(n)throw TypeError(n);var r=[F.increase(t),F.increase("".concat(t,":entering"))],o=Z((function(n,r){if(t===n){for(var o=arguments.length,i=new Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];e.apply(void 0,[r].concat(i))}}));return function(){o(),r.map((function(t){return t()}))}},onEvent:X,onExited:function(t,e){var n=E("onExited",{state:"string",cb:"function"},t,e);if(n)throw TypeError(n);var r=[F.increase(t),F.increase("".concat(t,":exited"))],o=tt((function(n,r){if(t===r){for(var o=arguments.length,i=new Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];e.apply(void 0,[n].concat(i))}}));return function(){o(),r.map((function(t){return t()}))}},onExiting:function(t,e){var n=E("onExiting",{state:"string",cb:"function"},t,e);if(n)throw TypeError(n);var r=[F.increase(t),F.increase("".concat(t,":exiting"))],o=Z((function(n,r){if(t===r){for(var o=arguments.length,i=new Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];e.apply(void 0,[n].concat(i))}}));return function(){o(),r.map((function(t){return t()}))}},onSwitched:tt,onSwitching:Z,onTransitions:function(t){return $(t,"onTransitions")},performTransitions:function(t){return $(t,"performTransitions")},previousState:W,reset:function(){S.warn("".concat(n,": State-machine reset!")),C.length=0,C.push(P)},statesAvailableFromHere:V}},isStatebot:function(t){return l(t)&&"number"==typeof t.__STATEBOT__}};var f=n(4),s=n(0),l=s.isPojo,p=s.ArgTypeError,v=s.Logger,y=s.isEventEmitter,h=s.ReferenceCounter,d=n(1),m=d.decomposeChart,b=d.cxArrow},function(t,e,n){var r=n(2),o=r.Statebot,i=r.isStatebot,a=n(5),c=a.assertRoute,u=a.routeIsPossible,f=n(1).decomposeChart;t.exports={Statebot:o,isStatebot:i,routeIsPossible:u,assertRoute:c,decomposeChart:f}},function(t,e,n){"use strict";var r,o="object"==typeof Reflect?Reflect:null,i=o&&"function"==typeof o.apply?o.apply:function(t,e,n){return Function.prototype.apply.call(t,e,n)};r=o&&"function"==typeof o.ownKeys?o.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var a=Number.isNaN||function(t){return t!=t};function c(){c.init.call(this)}t.exports=c,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._eventsCount=0,c.prototype._maxListeners=void 0;var u=10;function f(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function s(t){return void 0===t._maxListeners?c.defaultMaxListeners:t._maxListeners}function l(t,e,n,r){var o,i,a,c;if(f(n),void 0===(i=t._events)?(i=t._events=Object.create(null),t._eventsCount=0):(void 0!==i.newListener&&(t.emit("newListener",e,n.listener?n.listener:n),i=t._events),a=i[e]),void 0===a)a=i[e]=n,++t._eventsCount;else if("function"==typeof a?a=i[e]=r?[n,a]:[a,n]:r?a.unshift(n):a.push(n),(o=s(t))>0&&a.length>o&&!a.warned){a.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=t,u.type=e,u.count=a.length,c=u,console&&console.warn&&console.warn(c)}return t}function p(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function v(t,e,n){var r={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},o=p.bind(r);return o.listener=n,r.wrapFn=o,o}function y(t,e,n){var r=t._events;if(void 0===r)return[];var o=r[e];return void 0===o?[]:"function"==typeof o?n?[o.listener||o]:[o]:n?function(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}(o):d(o,o.length)}function h(t){var e=this._events;if(void 0!==e){var n=e[t];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function d(t,e){for(var n=new Array(e),r=0;r<e;++r)n[r]=t[r];return n}Object.defineProperty(c,"defaultMaxListeners",{enumerable:!0,get:function(){return u},set:function(t){if("number"!=typeof t||t<0||a(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");u=t}}),c.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},c.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||a(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},c.prototype.getMaxListeners=function(){return s(this)},c.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);var r="error"===t,o=this._events;if(void 0!==o)r=r&&void 0===o.error;else if(!r)return!1;if(r){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var c=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw c.context=a,c}var u=o[t];if(void 0===u)return!1;if("function"==typeof u)i(u,this,e);else{var f=u.length,s=d(u,f);for(n=0;n<f;++n)i(s[n],this,e)}return!0},c.prototype.addListener=function(t,e){return l(this,t,e,!1)},c.prototype.on=c.prototype.addListener,c.prototype.prependListener=function(t,e){return l(this,t,e,!0)},c.prototype.once=function(t,e){return f(e),this.on(t,v(this,t,e)),this},c.prototype.prependOnceListener=function(t,e){return f(e),this.prependListener(t,v(this,t,e)),this},c.prototype.removeListener=function(t,e){var n,r,o,i,a;if(f(e),void 0===(r=this._events))return this;if(void 0===(n=r[t]))return this;if(n===e||n.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete r[t],r.removeListener&&this.emit("removeListener",t,n.listener||e));else if("function"!=typeof n){for(o=-1,i=n.length-1;i>=0;i--)if(n[i]===e||n[i].listener===e){a=n[i].listener,o=i;break}if(o<0)return this;0===o?n.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(n,o),1===n.length&&(r[t]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",t,a||e)}return this},c.prototype.off=c.prototype.removeListener,c.prototype.removeAllListeners=function(t){var e,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[t]),this;if(0===arguments.length){var o,i=Object.keys(n);for(r=0;r<i.length;++r)"removeListener"!==(o=i[r])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=n[t]))this.removeListener(t,e);else if(void 0!==e)for(r=e.length-1;r>=0;r--)this.removeListener(t,e[r]);return this},c.prototype.listeners=function(t){return y(this,t,!0)},c.prototype.rawListeners=function(t){return y(this,t,!1)},c.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):h.call(t,e)},c.prototype.listenerCount=h,c.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},function(t,e,n){function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function o(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){i(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function i(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function a(t){return function(t){if(Array.isArray(t))return c(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return c(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return c(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}t.exports={routeIsPossible:function(t,e){var n=m("routeIsPossible",{machine:u,expectedRoute:d},t,e);if(n)throw TypeError(n);var r=f(e);return r.every((function(e,n){if(n===r.length-1)return!0;var o=r[n+1];return t.statesAvailableFromHere(e).includes(o)}))},assertRoute:function(t,e,n){var r=m("assertRoute",{machine:u,expectedRoute:d},t,e);if(r)throw TypeError(r);b+=1;var c=n||{},s=c.description,h=void 0===s?"Assertion complete":s,w=c.fromState,O=void 0===w?"":w,E=c.run,S=void 0===E?function(){}:E,A=c.permittedDeviations,j=void 0===A?0:A,T=c.timeoutInMs,L=void 0===T?1e3:T,_=c.logLevel,x=y(void 0===_?3:_),P="Statebot[".concat(t.name(),"]: aId<").concat(b,">"),I=f(e);x.log("\n".concat(P,": Asserting route: [").concat(I.join(" > "),"]")),x.log("".concat(P,': > Assertion will start from state: "').concat(O,'"'));var C,N=l(S),D=function(){},R=g(),M=g(),k=0,G=!0,F=!1,H=a(I),U=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=[],r=t.map((function(t,n){return e[n]||"center"})),c=!1;function u(){c=!0}function f(){for(var e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];if(!c){var u=t.reduce((function(t,e,n){return o({},t,i({},e,r[n]||""))}),{});n.push(u)}}function s(){return n.reduce((function(e,n){return t.map((function(t,r){return Math.max(n[t].length,e[r])}))}),t.map((function(){return 0})))}function l(t,e){return t+" ".repeat(e-t.length)}function p(t,e){return" ".repeat(e-t.length)+t}function v(){var e=s();return n.reduce((function(n,c){var u=t.reduce((function(t,n,a){return o({},t,i({},n,function(t,n){var o=e[n],i=r[n];return"left"===i?l(t,o):"right"===i?p(t,o):t}(c[n],a)))}),{});return[].concat(a(n),[u])}),[])}return{lock:u,addRow:f,content:v}}(["state","expected","info","took"],["center","center","left","right"]),$=p((function(t){return B("","","","TOTAL: "+R()),U.lock(),x.log("\n".concat(P,": ").concat(h,": [").concat(t?"FAILED":"SUCCESS","]")),x.table(U.content()),t})),B=U.addRow;return new Promise((function(e,n){if(0!==H.length){var r=function(e){for(;H.length;){var r=H.shift();B(t.currentState(),"(".concat(r,")"),e),F=!1}!function(t){clearTimeout(C),D(),c(),n(t)}($(new Error(e)))};t.inState(O)&&(G=!1,D=N());var o=v((function(t){C=setTimeout((function(){i(),r("TIMEOUT")}),L),function(t){if(G)B(t,"-","PENDING");else{var e=H[0];e===t?(B(t,e,F?"REALIGNED":"OKAY",M()),F=!1,H.shift()):(B(t,e,"WRONG STATE",M()),F=!0,k+=1),M=g()}}(t),G&&t===O&&(G=!1,D=N()),k>j&&(i(),r("TOO MANY DEVIATIONS")),H.length<=0&&(i(),function(){clearTimeout(C),D(),c(),e.apply(void 0,arguments)}($()))})),i=o.revoke,a=o.fn,c=t.onSwitching(a)}else n($(new Error("NO ROUTE TO TEST")))}))}};var u=n(2).isStatebot,f=n(1).decomposeRoute,s=n(0),l=s.Defer,p=s.Once,v=s.Revokable,y=s.Logger,h=s.ArgTypeError,d=s.isTemplateLiteral,m=h("statebot.");var b=0;function g(){var t=Date.now();function e(t,e){return t.toFixed(e).replace(/\.0+$/,"")}return function(){var n=Date.now()-t;return n<500?"".concat(e(n)," ms"):n<5e3?"".concat(e(n/1e3,2)," s "):n<6e4?"".concat(e(n/1e3,1)," s "):"".concat(e(n/1e3/60,1)," m ")}}}])}));