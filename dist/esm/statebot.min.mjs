/*
 * Statebot
 * v2.3.5
 * https://shuckster.github.io/statebot/
 * License: ISC
 */
function t(){}function e(){e.init.call(this)}function n(t){return void 0===t._maxListeners?e.defaultMaxListeners:t._maxListeners}function r(t,e,n){if(e)t.call(n);else for(var r=t.length,o=l(t,r),i=0;i<r;++i)o[i].call(n)}function o(t,e,n,r){if(e)t.call(n,r);else for(var o=t.length,i=l(t,o),s=0;s<o;++s)i[s].call(n,r)}function i(t,e,n,r,o){if(e)t.call(n,r,o);else for(var i=t.length,s=l(t,i),a=0;a<i;++a)s[a].call(n,r,o)}function s(t,e,n,r,o,i){if(e)t.call(n,r,o,i);else for(var s=t.length,a=l(t,s),c=0;c<s;++c)a[c].call(n,r,o,i)}function a(t,e,n,r){if(e)t.apply(n,r);else for(var o=t.length,i=l(t,o),s=0;s<o;++s)i[s].apply(n,r)}function c(e,r,o,i){var s,a,c,u;if("function"!=typeof o)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",r,o.listener?o.listener:o),a=e._events),c=a[r]):(a=e._events=new t,e._eventsCount=0),c){if("function"==typeof c?c=a[r]=i?[o,c]:[c,o]:i?c.unshift(o):c.push(o),!c.warned&&(s=n(e))&&s>0&&c.length>s){c.warned=!0;var f=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+r+" listeners added. Use emitter.setMaxListeners() to increase limit");f.name="MaxListenersExceededWarning",f.emitter=e,f.type=r,f.count=c.length,u=f,"function"==typeof console.warn?console.warn(u):console.log(u)}}else c=a[r]=o,++e._eventsCount;return e}function u(t,e,n){var r=!1;function o(){t.removeListener(e,o),r||(r=!0,n.apply(t,arguments))}return o.listener=n,o}function f(t){var e=this._events;if(e){var n=e[t];if("function"==typeof n)return 1;if(n)return n.length}return 0}function l(t,e){for(var n=new Array(e);e--;)n[e]=t[e];return n}t.prototype=Object.create(null),e.EventEmitter=e,e.usingDomains=!1,e.prototype.domain=void 0,e.prototype._events=void 0,e.prototype._maxListeners=void 0,e.defaultMaxListeners=10,e.init=function(){this.domain=null,e.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new t,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},e.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=t,this},e.prototype.getMaxListeners=function(){return n(this)},e.prototype.emit=function(t){var e,n,c,u,f,l,h,p="error"===t;if(l=this._events)p=p&&null==l.error;else if(!p)return!1;if(h=this.domain,p){if(e=arguments[1],!h){if(e instanceof Error)throw e;var m=new Error('Uncaught, unspecified "error" event. ('+e+")");throw m.context=e,m}return e||(e=new Error('Uncaught, unspecified "error" event')),e.domainEmitter=this,e.domain=h,e.domainThrown=!1,h.emit("error",e),!1}if(!(n=l[t]))return!1;var d="function"==typeof n;switch(c=arguments.length){case 1:r(n,d,this);break;case 2:o(n,d,this,arguments[1]);break;case 3:i(n,d,this,arguments[1],arguments[2]);break;case 4:s(n,d,this,arguments[1],arguments[2],arguments[3]);break;default:for(u=new Array(c-1),f=1;f<c;f++)u[f-1]=arguments[f];a(n,d,this,u)}return!0},e.prototype.addListener=function(t,e){return c(this,t,e,!1)},e.prototype.on=e.prototype.addListener,e.prototype.prependListener=function(t,e){return c(this,t,e,!0)},e.prototype.once=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.on(t,u(this,t,e)),this},e.prototype.prependOnceListener=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.prependListener(t,u(this,t,e)),this},e.prototype.removeListener=function(e,n){var r,o,i,s,a;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if(!(o=this._events))return this;if(!(r=o[e]))return this;if(r===n||r.listener&&r.listener===n)0==--this._eventsCount?this._events=new t:(delete o[e],o.removeListener&&this.emit("removeListener",e,r.listener||n));else if("function"!=typeof r){for(i=-1,s=r.length;s-- >0;)if(r[s]===n||r[s].listener&&r[s].listener===n){a=r[s].listener,i=s;break}if(i<0)return this;if(1===r.length){if(r[0]=void 0,0==--this._eventsCount)return this._events=new t,this;delete o[e]}else!(function(t,e){for(var n=e,r=n+1,o=t.length;r<o;n+=1,r+=1)t[n]=t[r];t.pop()})(r,i);o.removeListener&&this.emit("removeListener",e,a||n)}return this},e.prototype.removeAllListeners=function(e){var n,r;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=new t,this._eventsCount=0):r[e]&&(0==--this._eventsCount?this._events=new t:delete r[e]),this;if(0===arguments.length){for(var o,i=Object.keys(r),s=0;s<i.length;++s)"removeListener"!==(o=i[s])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=new t,this._eventsCount=0,this}if("function"==typeof(n=r[e]))this.removeListener(e,n);else if(n)do{this.removeListener(e,n[n.length-1])}while(n[0]);return this},e.prototype.listeners=function(t){var e,n=this._events;return n&&(e=n[t])?"function"==typeof e?[e.listener||e]:(function(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e})(e):[]},e.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):f.call(t,e)},e.prototype.listenerCount=f,e.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var h={isArray:p,isEventEmitter:function(t){return v(t)&&m(t.emit)&&m(t.addListener)&&m(t.removeListener)},isFunction:m,isPojo:function(t){if(null===t||!v(t))return!1;return Object.getPrototypeOf(t)===Object.prototype},isString:d,isTemplateLiteral:function(t){if(d(t))return!0;if(p(t))return t.every(t=>d(t));return!1},uniq:function(t){return t.reduce((t,e)=>-1===t.indexOf(e)?[...t,e]:t,[])},Defer:function(t){return(...e)=>(function(t,...e){const n=setTimeout(t,0,...e);return()=>{clearTimeout(n)}})(t,...e)},Once:function(t){const{revoke:e,fn:n}=g(t);let r;return function(...t){return r=n(...t),e(),r}},Revokable:g,ReferenceCounter:function(t,e,n,...r){const o={};function i(t){const e=s(t)-1;o[t]=Math.max(e,0)}function s(t){return o[t]||0}return[...r].flat().forEach(t=>{o[t]=0}),{increase:function(t){return o[t]=s(t)+1,()=>i(t)},decrease:i,countOf:s,toValue:function(){return{description:`Statebot[${t}]: ${n}:`,table:Object.keys(o).sort().map(t=>[t,o[t]]).map(([t,n])=>({[e]:t,refs:n||"None"}))}},refs:function(){return{...o}}}},ArgTypeError:function(t=""){return function(e,n,...r){const o=Object.entries(n).map(([t,e])=>({argName:t,argType:e})),i=Object.keys(n).join(", "),s=r.map((t,e)=>{const{argName:n,argType:r}=o[e];if(void 0===t)return`Argument undefined: "${n}"`;let i,s,a;return m(r)?(a=!0===r(t),s=r.name,i=`${s}(${n}) did not return true`):(a=typeof t===r,s=r,i=`Argument "${n}" should be a ${s}`),a?void 0:`${i}: ${n} === ${typeof t}(${t})`}).filter(Boolean);return s.length?`\n${t}${e}(${i}):\n`+s.map(t=>"> "+t).join("\n"):void 0}},Logger:function(t){let e=t;d(e)&&(e={info:3,log:2,warn:1,none:0}[e]||3);function n(){return e>=1}function r(){return e>=2}function o(){return e>=3}return{canWarn:n,canLog:r,canInfo:o,info:(...t)=>o()&&console.info(...t),table:(...t)=>r()&&console.table(...t),log:(...t)=>r()&&console.log(...t),warn:(...t)=>n()&&console.warn(...t),error:(...t)=>console.error(...t)}}};function p(t){return Array.isArray(t)}function m(t){return"function"==typeof t}function d(t){return"string"==typeof t}function v(t){return"object"==typeof t}function g(t){let e,n=!1;return{fn:(...r)=>(n||(e=t(...r)),e),revoke:()=>{n=!0}}}const y=/[\r\n]/,w="|",E="->",b=[w,E].map(t=>t.replace("|","\\|")).join("|"),T=new RegExp(`(${b})$`),$=/[^a-z0-9!@#$%^&*:_+=<>|~.\x2D]/gi,L=/(\/\/[^\n\r]*)/;var S={cxPipe:w,cxArrow:E,rxDisallowedCharacters:$,decomposeChart:function(t){const e=O("decomposeChart",{chart:A},t);if(e)throw TypeError(e);const n=j(C(t)),r=n.map(I).flat(1).map(N).flat(1),o=[],i=r.map(t=>(o.push(...t),t.join(E))),s=_(i),a=_(o);return{transitions:s.map(t=>t.split(E)),routes:s,states:a}},decomposeRoute:function(t){const e=O("decomposeRoute",{templateLiteral:A},t);if(e)throw TypeError(e);const n=C(t);return j(n).flat(2)}};const{uniq:_,ArgTypeError:x,isTemplateLiteral:A}=h,O=x("statebot.");function C(t){const e=(function(t){return[t].flat().reduce((t,e)=>[...t,e.split(y)],[]).flat()})(t),n=[];return e.reduce((t,e)=>{const r=e.replace(L,"").replace($,"");return r?T.test(r)?t+r:(n.push(t+r),""):t},""),n}function j(t){return t.map(t=>t.split(E).map(t=>t.split(w)))}function I(t){const e=[];return t.reduce((t,n)=>(!1===t||e.push([t,[...n]]),[...n]),!1),e}function N([t,e]){return t.reduce((t,n)=>[...t,...e.map(t=>[n,t])],[])}var R={Statebot:function(t,n){if(!F(t))throw TypeError("\nStatebot: Please specify a name for this machine");const r=`Statebot[${t}]`;if(!M(n))throw TypeError(`\n${r}: Please specify options for this machine`);const{chart:o,logLevel:i=3,historyLimit:s=2}=n||{},a=U(r+"#"),c=W(i),{canWarn:u}=c,{states:f=[],routes:l=[]}=o?B(o):n,{startIn:h=f[0]}=n;if(!f.includes(h))throw Error(`${r}: Starting-state not in chart: "${h}"`);let p=0;const m=[h],d=Math.max(s,2),v=P(n.events)?n.events:new e,g=new e,y={onSwitching:"(ANY)state:changing",onSwitched:"(ANY)state:changed"};function w(t,...e){return g.emit(t,...e)}function E(t,e){return g.addListener(t,e),function(){g.removeListener(t,e)}}const b=Y(t,"states","Listening for the following state-changes",[...f]),T=Y(t,"transitions","Listening for the following transitions",[...l]),$=Y(t,"events","Listening for the following events");function L(e,n){const r=D(e)?e({enter:C,emit:O,Enter:V,Emit:R}):M(e)?e:null;if(!M(r))throw TypeError(`Statebot[${t}]#${n}(): Expected an object, or a function that returns an object`);const o={},i=[];Object.entries(r).forEach(([t,e])=>{if(D(e))i.push({routeChart:t,action:e});else if(!M(e))return;const{on:n,then:r}=e;if(F(n)||k(n)){[n].flat().forEach(e=>{o[e]=o[e]||[],o[e].push({routeChart:t,action:r})})}else D(r)&&i.push({routeChart:t,action:e})});const s=[],a=[],h=Object.entries(o).reduce((t,[e,n])=>{const{states:r,routes:o,configs:i}=H(n,u);return u()&&(s.push(...r),a.push(...o)),{...t,[e]:i}},{}),p=[];p.push(...Object.entries(h).map(([t,e])=>[$.increase(t),j(t,(...n)=>{e.some(({fromState:t,toState:e,action:r})=>!!A(t,()=>(C(e,...n),D(r)&&r(...n),!0)))||q(`Event not handled: "${t}"`)})]).flat());const m=H(i,u);if(u()&&(s.push(...m.states),a.push(...m.routes)),p.push(...m.configs.map(t=>{const{fromState:e,toState:n,action:r}=t,o=`${e}->${n}`;return[T.increase(o),E(o,r)]}).flat()),u()){const e=s.filter(t=>!f.includes(t)),r=a.filter(t=>!l.includes(t));e.length&&c.warn(`Statebot[${t}]#${n}(): Invalid states specified:\n`+e.map(t=>`  > "${t}"`).join("\n")),r.length&&c.warn(`Statebot[${t}]#${n}(): Invalid transitions specified:\n`+r.map(t=>`  > "${t}"`).join("\n"))}return()=>p.forEach(t=>t())}function S(){return m[m.length-2]}function _(){return m[m.length-1]}function x(t){const e=void 0!==t?t:_(),n=a("statesAvailableFromHere",{state:F},e);if(n)throw TypeError(n);return l.reduce((t,n)=>{const[r,o]=n.split(G).map(t=>t.trim());return r===e?[...t,o]:t},[])}function A(t,e,...n){const r=a("inState",{state:F},t);if(r)throw TypeError(r);const o=_()===t;return void 0!==e?o?D(e)?e(...n):e:null:o}function O(t,...e){const n=a("emit",{eventName:F},t);if(n)throw TypeError(n);return v.emit(t,...e)}function C(t,...e){const n=a("enter",{state:F},t);if(n)throw TypeError(n);const o=_(),i=t;if(i===o)return q(`Already in state: "${i}"`),!1;if(!f.includes(i))return q(`Invalid state "${i}", not switching`),!1;const s=`${o}->${i}`;return l.includes(s)?(c.info(`${r}: tId<${++p}>: ${s}`),m.push(i),m.length>d&&m.shift(),w(y.onSwitching,i,o,...e),w(s,...e),w(y.onSwitched,i,o,...e),!0):(q(`Invalid transition "${s}", not switching`),!1)}function j(t,e){const n=a("onEvent",{eventName:F,cb:D},t,e);if(n)throw TypeError(n);return v.addListener(t,e),()=>v.removeListener(t,e)}const I=Object.keys(y).reduce((t,e)=>({...t,[e]:function(t){const n=a(e,{cb:D},t);if(n)throw TypeError(n);const r=b.increase(y[e]),o=E(y[e],(e,n,...r)=>{t(e,n,...r)});return()=>{o(),r()}}}),{}),N=[["Exiting","onSwitching"],["Entering","onSwitching"],["Exited","onSwitched"],["Entered","onSwitched"]].reduce((t,e)=>{const[n,r]=e,o="on"+n,i=n.toLowerCase();return{...t,[o]:function(t,e){const s=a(o,{state:F,cb:D},t,e);if(s)throw TypeError(s);const c=[b.increase(t),b.increase(`${t}:${i}`)],u=I[r]((r,o,...i)=>{0===n.indexOf("Exit")?t===o&&e(r,...i):t===r&&e(o,...i)});return()=>{u(),c.map(t=>t())}}}},{});function R(t,...e){const n=a("Emit",{eventName:F},t);if(n)throw TypeError(n);return(...n)=>O(t,...e,...n)}function V(t,...e){const n=a("Enter",{state:F},t);if(n)throw TypeError(n);return(...n)=>C(t,...e,...n)}function q(t){const e=S(),n=_(),o=`${void 0===e?"[undefined]":e}->${n}`,i=x();i.length?c.info(`${r}: ${t}\n  > Previous transition: "${o}"\n  > From "${n}", valid states are: [${i.map(t=>`"${t}"`).join(", ")}]`):c.info(`${r}: ${t}\n  > Previous transition: "${o}"\n  > There are no states available from "${n}"`)}function K(t){const{description:e,table:n}=t.toValue();c.log(e),n.length?c.table(n):c.log("  > No information")}return{__STATEBOT__:1,canTransitionTo:function(...t){const e=t.flat(),n=a("canTransitionTo",{state:F},e[0]);if(n)throw TypeError(n);if(!e.length)return!1;const r=x();return e.every(t=>r.includes(t))},currentState:_,emit:O,Emit:R,enter:C,Enter:V,history:()=>[...m],info:()=>(c.log(r+": Information about this state-machine"),K(b),K(T),void K($)),inspect:()=>({states:b.refs(),transitions:T.refs(),events:$.refs()}),inState:A,InState:function(t,e,...n){const r=a("InState",{state:F},t);if(r)throw TypeError(r);return(...r)=>A(t,e,...n,...r)},name:()=>t,onEntered:N.onEntered,onEntering:N.onEntering,onEvent:j,onExited:N.onExited,onExiting:N.onExiting,onSwitched:I.onSwitched,onSwitching:I.onSwitching,onTransitions:t=>L(t,"onTransitions"),performTransitions:t=>L(t,"performTransitions"),previousState:S,reset:function(){c.warn(r+": State-machine reset!"),m.length=0,m.push(h)},statesAvailableFromHere:x}},isStatebot:function(t){return M(t)&&"number"==typeof t.__STATEBOT__}};const{isArray:k,isEventEmitter:P,isFunction:D,isPojo:M,isString:F,ArgTypeError:U,Logger:W,ReferenceCounter:Y}=h,{decomposeChart:B,cxArrow:G}=S;function H(t,e){const n=[],r=[];return{configs:t.reduce((t,o)=>{const{routeChart:i,action:s}=o,{states:a,routes:c,transitions:u}=B(i);return e()&&(n.push(...a),r.push(...c)),[...t,...u.map(t=>{const[e,n]=t;return{fromState:e,toState:n,action:s}})]},[]),states:n,routes:r}}var V={routeIsPossible:function(t,e){const n=et("routeIsPossible",{machine:q,route:tt},t,e);if(n)throw TypeError(n);const r=K(e);return r.every((e,n)=>{if(n===r.length-1)return!0;{const o=r[n+1];return t.statesAvailableFromHere(e).includes(o)}})},assertRoute:function(t,e,n){const r=et("assertRoute",{machine:q,expectedRoute:tt},t,e);if(r)throw TypeError(r);nt+=1;const{description:o="Assertion complete",fromState:i="",run:s=(()=>{}),permittedDeviations:a=0,timeoutInMs:c=1e3,logLevel:u=3}=n||{},f=X(u),l=`Statebot[${t.name()}]: aId<${nt}>`,h=K(e);f.log(`\n${l}: Asserting route: [${h.join(" > ")}]`),f.log(`${l}: > Assertion will start from state: "${i}"`);const p=z(s);let m=()=>{};const d=rt();let v,g=rt(),y=0,w=!0,E=!1;const b=[...h],T=(function(t=[],e=[]){const n=[],r=t.map((t,n)=>e[n]||"center");let o=!1;return{lock:function(){o=!0},addRow:function(...e){if(o)return;const r=t.reduce((t,n,r)=>({...t,[n]:e[r]||""}),{});n.push(r)},content:function(){const e=n.reduce((e,n)=>t.map((t,r)=>Math.max(n[t].length,e[r])),t.map(()=>0));function o(t,n){const o=e[n],i=r[n];return"left"===i?(s=t)+" ".repeat(o-s.length):"right"===i?(function(t,e){return" ".repeat(e-t.length)+t})(t,o):t;var s}return n.reduce((e,n)=>[...e,t.reduce((t,e,r)=>({...t,[e]:o(n[e],r)}),{})],[])}}})(["state","expected","info","took"],["center","center","left","right"]),$=J(t=>(L("","","","TOTAL: "+d()),T.lock(),f.log(`\n${l}: ${o}: [${t?"FAILED":"SUCCESS"}]`),f.table(T.content()),t)),{addRow:L}=T;return new Promise((e,n)=>{if(0===b.length)return void n($(new Error("NO ROUTE TO TEST")));const r=e=>{for(;b.length;){const n=b.shift();L(t.currentState(),`(${n})`,e),E=!1}(t=>{clearTimeout(v),m(),u(),n(t)})($(new Error(e)))};t.inState(i)&&(w=!1,m=p());const{revoke:o,fn:s}=Q(t=>{v=setTimeout(()=>{o(),r("TIMEOUT")},c),(function(t){if(w)L(t,"-","PENDING");else{const e=b[0];e===t?(L(t,e,E?"REALIGNED":"OKAY",g()),E=!1,b.shift()):(L(t,e,"WRONG STATE",g()),E=!0,y+=1),g=rt()}})(t),w&&t===i&&(w=!1,m=p()),y>a&&(o(),r("TOO MANY DEVIATIONS")),b.length<=0&&(o(),((...t)=>{clearTimeout(v),m(),u(),e(...t)})($()))}),u=t.onSwitching(s)})}};const{isStatebot:q}=R,{decomposeRoute:K}=S,{Defer:z,Once:J,Revokable:Q,Logger:X,ArgTypeError:Z,isTemplateLiteral:tt}=h,et=Z("statebot.");let nt=0;function rt(){const t=Date.now();function e(t,e){return t.toFixed(e).replace(/\.0+$/,"")}return function(){const n=Date.now()-t;return n<500?e(n)+" ms":n<5e3?e(n/1e3,2)+" s ":n<6e4?e(n/1e3,1)+" s ":e(n/1e3/60,1)+" m "}}const{Statebot:ot,isStatebot:it}=R,{assertRoute:st,routeIsPossible:at}=V,{decomposeChart:ct}=S;var ut={Statebot:ot,isStatebot:it,routeIsPossible:at,assertRoute:st,decomposeChart:ct};export default ut;
