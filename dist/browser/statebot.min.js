/*
 * Statebot
 * v3.0.5
 * https://shuckster.github.io/statebot/
 * License: MIT
 */
var statebot=(function(t){"use strict";function n(t){return{all:t=t||new Map,on:function(n,e){var r=t.get(n);r?r.push(e):t.set(n,[e])},off:function(n,e){var r=t.get(n);r&&(e?r.splice(r.indexOf(e)>>>0,1):t.set(n,[]))},emit:function(n,e){var r=t.get(n);r&&r.slice().map((function(t){t(e)})),(r=t.get("*"))&&r.slice().map((function(t){t(n,e)}))}}}function e(t){return l(t)&&i(t.emit)&&(i(t.addListener)||i(t.on))&&(i(t.removeListener)||i(t.off))}function r(t){return Array.isArray(t)}function o(t){return"[object Arguments]"===Object.prototype.toString.call(t)}function i(t){return"function"==typeof t}function s(t){return"string"==typeof t}function a(t){return r(t)&&t.every(s)}function u(t){return void 0===t}function c(t){return null===t}function f(t){return"number"==typeof t}function l(t){return"object"==typeof t&&!c(t)}function p(t){return!(c(t)||!l(t)||o(t))&&Object.getPrototypeOf(t)===Object.prototype}function h(t){return!!s(t)||!!r(t)&&t.every(s)}e.displayName="isEventEmitter",r.displayName="isUnset",r.displayName="isArray",o.displayName="isArguments",i.displayName="isFunction",s.displayName="isString",a.displayName="isAllStrings",u.displayName="isUndefined",c.displayName="isNull",f.displayName="isNumber",l.displayName="isObject",p.displayName="isPojo",h.displayName="isTemplateLiteral";const m=t=>(n,e)=>{if(e>=t.length)return;const{argName:r,argType:o}=t[e];if(u(n))return`Argument undefined: "${r}"`;const a=Array.isArray(o)?o:[o],c=a.map((t=>i(t)?((t,n,e)=>n(e)?void 0:(n.displayName||n.name)+`(${t}) did not return true`)(r,t,n):((t,n,e)=>typeof e===n?void 0:`Argument "${t}" should be a ${n}`)(r,t,n))).filter(s);return(a.length>1?c.length>1:c.length)?c.join("\n| ")+`\n> typeof ${r} === ${typeof n}(${JSON.stringify(n)})`:void 0};function d(t){return n=>{const e=Object.entries(n).map((t=>{let[n,e]=t;return{argName:n,argType:e}}));return r=>function(){for(var i=arguments.length,a=new Array(i),u=0;u<i;u++)a[u]=arguments[u];const c=Array.from(a,(t=>o(t)?Array.from(t):t)).flat(1),f=c.map(m(e)).filter(s);if(!f.length)return;const l=Object.keys(n).join(", ");return`\n${t||""}${r}(${l}):\n${f.map((t=>`| ${t}`)).join("\n")}`}}}function g(t){const n=t.addListener?function(){return t.addListener(...arguments)}:function(){return t.on(...arguments)},e=t.removeListener?function(){return t.removeListener(...arguments)}:function(){return t.off(...arguments)},r=new Map;return{emit:function(n){for(var e=arguments.length,r=new Array(e>1?e-1:0),o=1;o<e;o++)r[o-1]=arguments[o];return t.emit(n,r)},on:function(t,e){let o=r.get(e);o||(o={handleEvent:function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e(...[t].flat())},refCount:0},r.set(e,o)),o.refCount+=1,n(t,o.handleEvent)},off:function(t,n){let o=r.get(n);o&&(e(t,o.handleEvent),o.refCount-=1,0===o.refCount&&r.delete(n))}}}function y(t){return t.reduce(((t,n)=>-1===t.indexOf(n)?(t.push(n),t):t),[])}function w(t){for(var n=arguments.length,e=new Array(n>1?n-1:0),r=1;r<n;r++)e[r-1]=arguments[r];const o=setTimeout(t,0,...e);return()=>{clearTimeout(o)}}function v(t){const{revoke:n,fn:e}=$(t);let r;return function(){return r=e(...arguments),n(),r}}function $(t){let n,e=!1;return{fn:function(){return e||(n=t(...arguments)),n},revoke:()=>{e=!0}}}function E(t,n,e){for(var r=arguments.length,o=new Array(r>3?r-3:0),i=3;i<r;i++)o[i-3]=arguments[i];const s=[...o].flat().reduce(((t,n)=>({...t,[n]:0})),{});function a(t){return s[t]=c(t)+1,()=>{u(t)}}function u(t){const n=c(t)-1;s[t]=Math.max(n,0)}function c(t){return s[t]||0}function f(){return{...s}}function l(){return Object.keys(s).sort().map((t=>[t,s[t]])).map((t=>{let[e,r]=t;return{[n]:e,refs:r||"None"}}))}function p(){return{description:`${t}: ${e}:`,table:l()}}return{increase:a,decrease:u,countOf:c,toValue:p,refs:f}}function b(t,n){function e(){return t>=1}function r(){return t>=2}function o(){return t>=3}s(t)&&(t={info:3,log:2,warn:1,none:0}[t]||3);const{info:i,table:a,log:u,warn:c,error:f}=n||console;return{canWarn:e,canLog:r,canInfo:o,info:function(){o()&&i(...arguments)},table:function(){r()&&a(...arguments)},log:function(){r()&&u(...arguments)},warn:function(){e()&&c(...arguments)},error:function(){f(...arguments)}}}const T=/[\r\n]/,S="|",A="->",O=[S,A].map((t=>t.replace("|","\\|"))).join("|"),N=new RegExp(`(${O})$`),j=/[^a-z0-9!@#$%^&*:_+=<>|~.\x2D]/gi,I=/(\/\/[^\n\r]*)/,L=d("statebot.");function x(t){const n=L({templateLiteral:h})("decomposeRoute")(t);if(n)throw TypeError(n);return C(M(t)).flat(2)}function k(t){const n=L({chart:h})("decomposeChart")(t);if(n)throw TypeError(n);const e=C(M(t)),r=e.flatMap(P).flatMap(R);let o=!1;const i=y(r.map((t=>(t.includes("")&&(o=!0),t.join(A))))),s=y(e.flat(3));return{transitions:i.map((t=>t.split(A))),routes:i,states:o?s:s.filter(Boolean)}}function M(t){const n=(function(t){return[t].flat().reduce(((t,n)=>[...t,...n.split(T)]),[])})(t),e=[];let r=!1;const o=n.reduce(((t,n)=>{const o=n.replace(I,"").replace(j,"");return o?(r=N.test(o),r?t+o:(e.push(t+o),"")):t}),"");return r||o?[...e,o]:[...e]}function C(t){return t.map((t=>t.split(A).map((t=>t.split(S)))))}function P(t){const n=[];return t.reduce(((t,e)=>(!1===t||n.push([t,[...e]]),[...e])),!1),n}function R(t){let[n,e]=t;return n.reduce(((t,n)=>(t.push(...e.map((t=>[n,t]))),t)),[])}const F="onExiting",_="onEntering",D="onExited",U="onEntered",H="onSwitching",W="onSwitched",Y={[H]:"(ANY)state:changing",[W]:"(ANY)state:changed"};function B(t,o){if(!s(t))throw new TypeError("\nStatebot: Please specify a name for this machine");const c=`Statebot[${t}]`;if(!p(o))throw new TypeError(`\n${c}: Please specify options for this machine`);const{chart:f,logLevel:l=3,historyLimit:h=2}=o||{},m=u(o.events)?g(n()):e(o.events)&&g(o.events);if(!m)throw new TypeError(`\n${c}: Invalid event-emitter specified in options`);const{states:y=[],routes:w=[]}=f?k(f):o,{startIn:$=y[0]}=o;if(!y.includes($))throw new Error(`${c}: Starting-state not in chart: "${$}"`);const T=d(`${c}#`),S=b(l,console),{canWarn:O}=S,N=[$],j=Math.max(h,2);let I=0;const{pause:L,resume:x,paused:M,Pausable:C}=(function(t,n){n=n||function(){};let e=!!t;return{Pausable:function(t){return function(){return e?(n(),!1):t(...arguments)}},paused:()=>e,pause:()=>{e=!0},resume:()=>{e=!1}}})(!1,(()=>S.warn(`${c}: Ignoring callback, paused`))),P=(function(){const t={};function n(n,e){t[n]=(t[n]||[]).filter((t=>t!==e)),0===t[n].length&&delete t[n]}return{define:function(e,r){return t[e]=t[e]||[],t[e].push(r),()=>n(e,r)},undefine:n,definitionsOf:function(n){return t[n]||[]}}})(),R=g(n()),B=C(R.emit);function V(t,n){return R.on(t,n),()=>R.off(t,n)}const z=E(c,"states","Listening for the following state-changes",[...y]),J=E(c,"transitions","Listening for the following transitions",[...w]),K=E(c,"events","Listening for the following events");function q(t,n){const e=i(t)?t({enter:st,emit:it,Enter:lt,Emit:ft}):p(t)?t:null;if(!p(e))throw new TypeError(`${c}#${n}(): Expected an object, or a function that returns an object`);const o=[],a=[],{transitionsForEvents:u,transitionsOnly:f}=(function(t){const n={},e=[];return Object.entries(t).map((t=>{let[o,a]=t;if(i(a))return void e.push({routeChart:o,action:a});if(!p(a))return;const{on:u,then:c}=a;if(s(u)||r(u)){[u].flat().map((t=>{n[t]=n[t]||[],n[t].push({routeChart:o,action:c})}))}else i(c)&&e.push({routeChart:o,action:a})})),{transitionsForEvents:n,transitionsOnly:e}})(e),l=Object.entries(u).reduce((function(t,n){let[e,r]=n;const{states:i,routes:s,configs:u}=G(r,O);O()&&(o.push(...i),a.push(...s));return{...t,[e]:u}}),{}),h=G(f,O),m=Object.entries(l).map((function(t){let[n,e]=t;return[K.increase(n),at(n,(function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];const i=e.map((t=>({...t,args:r}))).some(d);i||mt(`Event not handled: "${n}"`)}))].concat(e.map((t=>{let{fromState:e,toState:r}=t;return P.define(`${n}:${e}`,r)})))})).concat(h.configs.map((function(t){const{fromState:n,toState:e,action:r}=t,o=`${n}->${e}`;return[J.increase(o),V(o,(i=e,s=r,function(){for(var t=arguments.length,n=new Array(t),e=0;e<t;e++)n[e]=arguments[e];return g(i,s,...n)}))];var i,s}))).flat();if(O()){o.push(...h.states),a.push(...h.routes);const t=o.filter((t=>!y.includes(t))),e=a.filter((t=>!w.includes(t)));t.length&&S.warn(`${c}#${n}(): Invalid states specified:\n`+t.map((t=>`  > "${t}"`)).join("\n")),e.length&&S.warn(`${c}#${n}(): Invalid transitions specified:\n`+e.map((t=>`  > "${t}"`)).join("\n"))}return()=>m.map((t=>t()));function d(t){let{fromState:n,toState:e,action:r,args:o}=t;return ot(n,(()=>(st(e,...o),i(r)&&g(e,r,...o),!0)))}function g(t,n){for(var e=arguments.length,r=new Array(e>2?e-2:0),o=2;o<e;o++)r[o-2]=arguments[o];const s=n(...r);if(i(s)){const n=v(ct[F](t,(t=>{n(),s(t)})));m.push(n)}}}function Q(t,n){let e=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const r=T({eventName:s})("peek")(t);if(r)throw new TypeError(r);const o=t+":"+Z(),a=P.definitionsOf(o);if(a.length>1){const n=`${c}: Event "${t}" causes multiple transitions.\n  > From state: "${Z()}"\n  > To states: "${a.join(", ")}"\n\nCheck your performTransitions() config.`;throw new RangeError(n)}e||0!==a.length||(0===K.countOf(t)?S.warn(`${c}: Event not handled: "${t}"`):S.warn(`${c}: Will not transition after emitting: "${t}"`));const f=a[0];if(u(n))return u(f)?Z():f;const l=T({stateObject:p})("peek")(n);if(l)throw new TypeError(l);if(Object.prototype.hasOwnProperty.call(n,f)){const t=n[f];return i(t)?t():t}return null}function X(){return N[N.length-2]}function Z(){return N[N.length-1]}function tt(){for(var t=arguments.length,n=new Array(t),e=0;e<t;e++)n[e]=arguments[e];const r=T({states:a})("canTransitionTo")([n]);if(r)throw new TypeError(r);if(!n.length)return!1;const o=nt();return n.every((t=>o.includes(t)))}function nt(t){const n=u(t)?Z():t,e=T({state:s})("statesAvailableFromHere")(n);if(e)throw new TypeError(e);return w.reduce(((t,e)=>{const[r,o]=e.split(A).map((t=>t.trim()));return r===n?[...t,o]:t}),[])}function et(t,n){const e=Z()===t;if(u(n))return e;if(!e)return null;if(i(n)){for(var r=arguments.length,o=new Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];return n(...o)}return n}function rt(t){const n=Object.entries(t).find((t=>{let[n]=t;return et(n)}));for(var e=arguments.length,r=new Array(e>1?e-1:0),o=1;o<e;o++)r[o-1]=arguments[o];return n?et(...n.concat(r)):null}function ot(){const t=T({state:[s,p]})("inState")(arguments.length<=0?void 0:arguments[0]);if(t)throw new TypeError(t);return p(arguments.length<=0?void 0:arguments[0])?rt(...arguments):et(...arguments)}const it=function(t){const n=T({eventName:s})("emit")(t);if(n)throw new TypeError(n);Q(t);for(var e=arguments.length,r=new Array(e>1?e-1:0),o=1;o<e;o++)r[o-1]=arguments[o];return m.emit(t,...r)},st=function(t){const n=T({state:s})("enter")(t);if(n)throw new TypeError(n);const e=Z(),r=t;if(r===e)return mt(`Already in state: "${r}"`),!1;if(!y.includes(r))return mt(`Invalid state "${r}", not switching`),!1;const o=`${e}->${r}`;if(!w.includes(o))return mt(`Invalid transition "${o}", not switching`),!1;S.info(`${c}: tId<${++I}>: ${o}`),N.push(r),N.length>j&&N.shift();for(var i=arguments.length,a=new Array(i>1?i-1:0),u=1;u<i;u++)a[u-1]=arguments[u];return B(Y[H],r,e,...a),B(o,...a),B(Y[W],r,e,...a),!0};function at(t,n){const e=T({eventName:s,cb:i})("onEvent")(t,n);if(e)throw new TypeError(e);return m.on(t,n),()=>m.off(t,n)}const ut=Object.keys(Y).reduce(((t,n)=>({...t,[n]:t=>{const e=T({cb:i})(n)(t);if(e)throw new TypeError(e);const r=z.increase(Y[n]),o=V(Y[n],t);return()=>{o(),r()}}})),{}),ct=[[F,H],[_,H],[D,W],[U,W]].reduce(((t,n)=>{const[e,r]=n,o=e.slice(2),a=o.toLowerCase();return{...t,[e]:(t,n)=>{const u=T({state:s,cb:i})(e)(t,n);if(u)throw new TypeError(u);const c=[z.increase(t),z.increase(`${t}:${a}`)],f=ut[r]((function(e,r){for(var i=arguments.length,s=new Array(i>2?i-2:0),a=2;a<i;a++)s[a-2]=arguments[a];0===o.indexOf("Exit")?t===r&&n(e,...s):t===e&&n(r,...s)}));return()=>{f(),c.map((t=>t()))}}}}),{});function ft(t){for(var n=arguments.length,e=new Array(n>1?n-1:0),r=1;r<n;r++)e[r-1]=arguments[r];const o=T({eventName:s})("Emit")(t);if(o)throw new TypeError(o);return function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];return it(t,...e,...r)}}function lt(t){for(var n=arguments.length,e=new Array(n>1?n-1:0),r=1;r<n;r++)e[r-1]=arguments[r];const o=T({state:s})("Enter")(t);if(o)throw new TypeError(o);return function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];return st(t,...e,...r)}}function pt(t,n){for(var e=arguments.length,r=new Array(e>2?e-2:0),o=2;o<e;o++)r[o-2]=arguments[o];return function(){for(var e=arguments.length,o=new Array(e),i=0;i<e;i++)o[i]=arguments[i];return ot(t,n,...r,...o)}}function ht(t){for(var n=arguments.length,e=new Array(n>1?n-1:0),r=1;r<n;r++)e[r-1]=arguments[r];return function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];return ot(t,...e,...r)}}function mt(t){const n=X(),e=Z(),r=`${u(n)?"[undefined]":n}->${e}`,o=nt();o.length?S.info(`${c}: ${t}\n  > Previous transition: "${r}"\n  > From "${e}", valid states are: [${o.map((t=>`"${t}"`)).join(", ")}]`):S.info(`${c}: ${t}\n  > Previous transition: "${r}"\n  > There are no states available from "${e}"`)}function dt(t){const{description:n,table:e}=t.toValue();S.log(n),e.length?S.table(e):S.log("  > No information")}return{__STATEBOT__:1,statesAvailableFromHere:nt,canTransitionTo:function(){for(var t=arguments.length,n=new Array(t),e=0;e<t;e++)n[e]=arguments[e];const r=n.flat();if(2===r.length&&s(r[0])&&p(r[1])){const t=r[0],{afterEmitting:n}=r[1],e=T({thisState:s,"{ afterEmitting }":s})("canTransitionTo")(t,n);if(e)throw new TypeError(e);return t!==Z()&&Q(n)===t}return tt(...r)},currentState:Z,previousState:X,history:()=>[...N],emit:C(it),Emit:C(ft),enter:C(st),Enter:C(lt),inState:ot,InState:function(){const t=T({state:[s,p]})("InState")(arguments.length<=0?void 0:arguments[0]);if(t)throw new TypeError(t);return p(arguments.length<=0?void 0:arguments[0])?ht(...arguments):pt(...arguments)},info:()=>(S.log(`${c}: Information about this state-machine`),dt(z),dt(J),void dt(K)),inspect:()=>({states:z.refs(),transitions:J.refs(),events:K.refs()}),name:()=>t,onEntered:ct[U],onEntering:ct[_],onExited:ct[D],onExiting:ct[F],onSwitched:ut[W],onSwitching:ut[H],onEvent:at,onTransitions:t=>q(t,"onTransitions"),performTransitions:t=>q(t,"performTransitions"),pause:L,paused:M,peek:function(t,n){return Q(t,n,!1)},reset:function(){S.warn(`${c}: State-machine reset!`),N.length=0,N.push($)},resume:x}}function G(t,n){const e=[],r=[];return{configs:t.reduce(((t,o)=>{const{routeChart:i,action:s}=o,{states:a,routes:u,transitions:c}=k(i);return n()&&(e.push(...a),r.push(...u)),[...t,...c.map((t=>{let[n,e]=t;return{fromState:n,toState:e,action:s}}))]}),[]),states:e,routes:r}}function V(t){return p(t)&&f(t.__STATEBOT__)}const z=d("statebot.");let J=0;function K(){const t=Date.now();function n(t,n){return t.toFixed(n).replace(/\.0+$/,"")}return function(){const e=Date.now()-t;return e<500?`${n(e)} ms`:e<5e3?`${n(e/1e3,2)} s `:e<6e4?`${n(e/1e3,1)} s `:`${n(e/1e3/60,1)} m `}}const{useEffect:q,useState:Q,useMemo:X}=(Z=window,"undefined"!=typeof React?React:Z);var Z;const{useStatebot:tt,useStatebotFactory:nt,useStatebotEvent:et}=(t=>{let{Statebot:n,useEffect:e,useState:r,useMemo:o}=t;function i(t){const[n,o]=r(t.currentState());return e((()=>{let n=!1;const e=t.onSwitched((t=>{n||o(t)}));return()=>{n=!0,e()}}),[t]),n}return[e,r,o].every((t=>"function"==typeof t))||console.warn("Statebot Hooks unavailable: React or Mithril not found"),{useStatebot:i,useStatebotFactory:function(t,r){const{bot:s,listeners:a}=o((()=>{const{performTransitions:e={},onTransitions:o={},...i}=r||{},s=n(t,i),a=[s.performTransitions(e),s.onTransitions(o)];return{bot:s,listeners:a}}),[]);return e((()=>()=>{"function"==typeof s.pause&&s.pause(),a.forEach((t=>t()))}),[s,a]),{state:i(s),bot:s}},useStatebotEvent:function(t,n,r,o){e((()=>{let e=!1;const i="function"==typeof o?[r,function(){e||o(...arguments)}]:[function(){e||r(...arguments)}],s=t[n](...i);return()=>{e=!0,s()}}),[t,n,r,o])}}})({Statebot:B,useEffect:q,useState:Q,useMemo:X});return t.Statebot=B,t.assertRoute=function(t,n,e){const r=z({machine:V,expectedRoute:h})("assertRoute")(t,n);if(r)throw TypeError(r);J+=1;const{description:o="Assertion complete",fromState:i="",run:s=(()=>{}),permittedDeviations:a=0,timeoutInMs:u=1e3,logLevel:c=3}=e||{},f=b(c),l=`Statebot[${t.name()}]: aId<${J}>`,p=x(n);f.log(`\n${l}: Asserting route: [${p.join(" > ")}]`),f.log(`${l}: > Assertion will start from state: "${i}"`);const m=(d=s,function(){for(var t=arguments.length,n=new Array(t),e=0;e<t;e++)n[e]=arguments[e];return w(d,...n)});var d;let g=()=>{};const y=K();let E,T=K(),S=0,A=!0,O=!1;const N=[...p],j=(function(t,n){n=n||[];const e=[],r=(t=t||[]).map(((t,e)=>n[e]||"center"));let o=!1;function i(){o=!0}function s(){for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];if(o)return;const s=t.reduce(((t,n,e)=>({...t,[n]:r[e]||""})),{});e.push(s)}function a(){return e.reduce(((n,e)=>t.map(((t,r)=>Math.max(e[t].length,n[r])))),t.map((()=>0)))}function u(){const n=a();function o(t,e){const o=n[e],i=r[e];return"left"===i?t.padEnd(o):"right"===i?t.padStart(o):t}return e.reduce(((n,e)=>{const r=t.reduce(((t,n,r)=>({...t,[n]:o(e[n],r)})),{});return[...n,r]}),[])}return{lock:i,addRow:s,content:u}})(["state","expected","info","took"],["center","center","left","right"]),I=v((t=>(L("","","","TOTAL: "+y()),j.lock(),f.log(`\n${l}: ${o}: [${t?"FAILED":"SUCCESS"}]`),f.table(j.content()),t))),{addRow:L}=j;return new Promise(((n,e)=>{if(0===N.length)return void e(I(new Error("NO ROUTE TO TEST")));const r=n=>{for(;N.length;){const e=N.shift();L(t.currentState(),`(${e})`,n),O=!1}(t=>{clearTimeout(E),g(),c(),e(t)})(I(new Error(n)))};t.inState(i)&&(A=!1,g=m());const{revoke:o,fn:s}=$((t=>{E=setTimeout((()=>{o(),r("TIMEOUT")}),u),(function(t){if(A)L(t,"-","PENDING");else{const n=N[0];n===t?(L(t,n,O?"REALIGNED":"OKAY",T()),O=!1,N.shift()):(L(t,n,"WRONG STATE",T()),O=!0,S+=1),T=K()}})(t),A&&t===i&&(A=!1,g=m()),S>a&&(o(),r("TOO MANY DEVIATIONS")),N.length<=0&&(o(),(function(){clearTimeout(E),g(),c(),n(...arguments)})(I()))})),c=t.onSwitching(s)}))},t.decomposeChart=k,t.isStatebot=V,t.routeIsPossible=function(t,n){const e=z({machine:V,route:h})("routeIsPossible")(t,n);if(e)throw TypeError(e);const r=x(n);return r.every(((n,e)=>{if(e===r.length-1)return!0;{const o=r[e+1];return t.statesAvailableFromHere(n).includes(o)}}))},t.useStatebot=tt,t.useStatebotEvent=et,t.useStatebotFactory=nt,Object.defineProperty(t,"__esModule",{value:!0}),t})({});
