/*
 * Statebot
 * v2.7.1
 * https://shuckster.github.io/statebot/
 * License: MIT
 */
"use strict";function t(t){return{all:t=t||new Map,on:function(n,e){var r=t.get(n);r&&r.push(e)||t.set(n,[e])},off:function(n,e){var r=t.get(n);r&&r.splice(r.indexOf(e)>>>0,1)},emit:function(n,e){(t.get(n)||[]).slice().map((function(t){t(e)})),(t.get("*")||[]).slice().map((function(t){t(n,e)}))}}}function n(t){return Array.isArray(t)}function e(t){return"function"==typeof t}function r(t){return"string"==typeof t}function o(t){return"object"==typeof t}function i(t){return!(null===t||!o(t))&&Object.getPrototypeOf(t)===Object.prototype}function s(t){return!!r(t)||!!n(t)&&t.every(r)}Object.defineProperty(exports,"__esModule",{value:!0});function c(t){return function(n,o,...i){const s=Object.entries(o).map((([t,n])=>({argName:t,argType:n}))),c=i.map(((...t)=>((t,n,o)=>{const{argName:i,argType:s}=t[o];if(void 0===n)return`Argument undefined: "${i}"`;const c=Array.isArray(s)?s:[s],a=c.map((t=>e(t)?((t,n,e)=>n(e)?void 0:`${n.name}(${t}) did not return true`)(i,t,n):((t,n,e)=>typeof e===n?void 0:`Argument "${t}" should be a ${n}`)(i,t,n))).filter(r);return(c.length>1?a.length>1:a.length)?`${a.join("\n| ")}\n> typeof ${i} === ${typeof n}(${JSON.stringify(n)})`:void 0})(s,...t))).filter(r);if(!c.length)return;const a=Object.keys(o).join(", ");return`\n${t||""}${n}(${a}):\n${c.map((t=>`| ${t}`)).join("\n")}`}}function a(t){const n=t.addListener?(...n)=>t.addListener(...n):(...n)=>t.on(...n),e=t.removeListener?(...n)=>t.removeListener(...n):(...n)=>t.off(...n),r=new Map;return{emit:(n,...e)=>t.emit(n,e),on:function(t,e){let o=r.get(e);o||(o={handleEvent:t=>e(...t||[]),refCount:0},r.set(e,o)),o.refCount+=1,n(t,o.handleEvent)},off:function(t,n){let o=r.get(n);o&&(e(t,o.handleEvent),o.refCount-=1,0===o.refCount&&r.delete(n))}}}function u(t){return t.reduce(((t,n)=>-1===t.indexOf(n)?[...t,n]:t),[])}function f(t){return(...n)=>(function(t,...n){const e=setTimeout(t,0,...n);return()=>{clearTimeout(e)}})(t,...n)}function l(t){let n,e=!1;return{fn:(...r)=>(e||(n=t(...r)),n),revoke:()=>{e=!0}}}function p(t,n,e,...r){const o=[...r].flat().reduce(((t,n)=>({...t,[n]:0})),{});function i(t){const n=s(t)-1;o[t]=Math.max(n,0)}function s(t){return o[t]||0}return{increase:function(t){return o[t]=s(t)+1,()=>{i(t)}},decrease:i,countOf:s,toValue:function(){return{description:`Statebot[${t}]: ${e}:`,table:Object.keys(o).sort().map((t=>[t,o[t]])).map((([t,e])=>({[n]:t,refs:e||"None"})))}},refs:function(){return{...o}}}}function m(t,n){function e(){return t>=1}function o(){return t>=2}function i(){return t>=3}r(t)&&(t={info:3,log:2,warn:1,none:0}[t]||3);const{info:s,table:c,log:a,warn:u,error:f}=n||console;return{canWarn:e,canLog:o,canInfo:i,info:(...t)=>{i()&&s(...t)},table:(...t)=>{o()&&c(...t)},log:(...t)=>{o()&&a(...t)},warn:(...t)=>{e()&&u(...t)},error:(...t)=>{f(...t)}}}const h=/[\r\n]/,d="|",g="->",$=[d,g].map((t=>t.replace("|","\\|"))).join("|"),w=new RegExp(`(${$})$`),E=/[^a-z0-9!@#$%^&*:_+=<>|~.\x2D]/gi,v=/(\/\/[^\n\r]*)/,T=c("statebot.");function y(t){const n=T("decomposeRoute",{templateLiteral:s},t);if(n)throw TypeError(n);return O(S(t)).flat(2)}function b(t){const n=T("decomposeChart",{chart:s},t);if(n)throw TypeError(n);const e=O(S(t)),r=e.map(A).flat(1).map(j).flat(1);let o=!1;const i=u(r.map((t=>(t.includes("")&&(o=!0),t.join(g))))),c=u(e.flat(3));return{transitions:i.map((t=>t.split(g))),routes:i,states:o?c:c.filter(Boolean)}}function S(t){const n=(function(t){return[t].flat().reduce(((t,n)=>[...t,n.split(h)]),[]).flat()})(t),e=[];let r=!1;const o=n.reduce(((t,n)=>{const o=n.replace(v,"").replace(E,"");return o?(r=w.test(o),r?t+o:(e.push(t+o),"")):t}),"");return r||o?[...e,o]:[...e]}function O(t){return t.map((t=>t.split(g).map((t=>t.split(d)))))}function A(t){const n=[];return t.reduce(((t,e)=>(!1===t||n.push([t,[...e]]),[...e])),!1),n}function j([t,n]){return t.reduce(((t,e)=>[...t,...n.map((t=>[e,t]))]),[])}const x="onExiting",I="onEntering",L="onExited",N="onEntered",C="onSwitching",P="onSwitched",_={[C]:"(ANY)state:changing",[P]:"(ANY)state:changed"};function k(t,n){const e=[],r=[];return{configs:t.reduce(((t,o)=>{const{routeChart:i,action:s}=o,{states:c,routes:a,transitions:u}=b(i);return n()&&(e.push(...c),r.push(...a)),[...t,...u.map((([t,n])=>({fromState:t,toState:n,action:s})))]}),[]),states:e,routes:r}}function R(t){return i(t)&&"number"==typeof t.__STATEBOT__}const M=c("statebot.");let D=0;function F(){const t=Date.now();function n(t,n){return t.toFixed(n).replace(/\.0+$/,"")}return function(){const e=Date.now()-t;return e<500?`${n(e)} ms`:e<5e3?`${n(e/1e3,2)} s `:e<6e4?`${n(e/1e3,1)} s `:`${n(e/1e3/60,1)} m `}}exports.Statebot=function(s,u){if(!r(s))throw new TypeError("\nStatebot: Please specify a name for this machine");const f=`Statebot[${s}]`;if(!i(u))throw new TypeError(`\n${f}: Please specify options for this machine`);const{chart:l,logLevel:h=3,historyLimit:d=2}=u||{},$=void 0===u.events?a(t()):o(w=u.events)&&e(w.emit)&&(e(w.addListener)||e(w.on))&&(e(w.removeListener)||e(w.off))&&a(u.events);var w;if(!$)throw new TypeError(`\n${f}: Invalid event-emitter specified in options`);const{states:E=[],routes:v=[]}=l?b(l):u,{startIn:T=E[0]}=u;if(!E.includes(T))throw new Error(`${f}: Starting-state not in chart: "${T}"`);const y=c(`${f}#`),S=m(h,console),{canWarn:O}=S,A=[T],j=Math.max(d,2);let R=0;const{pause:M,resume:D,paused:F,Pausable:Y}=(function(t,n){n=n||function(){};let e=!!t;return{Pausable:function(t){return(...r)=>e?(n(),!1):t(...r)},paused:()=>e,pause:()=>{e=!0},resume:()=>{e=!1}}})(!1,(()=>S.warn(`${f}: Ignoring callback, paused`))),B=a(t()),G=Y(B.emit);function H(t,n){return B.on(t,n),()=>B.off(t,n)}const U=p(s,"states","Listening for the following state-changes",[...E]),V=p(s,"transitions","Listening for the following transitions",[...v]),W=p(s,"events","Listening for the following events");function z(t,o){const c=e(t)?t({enter:tt,emit:Z,Enter:it,Emit:ot}):i(t)?t:null;if(!i(c))throw new TypeError(`Statebot[${s}]#${o}(): Expected an object, or a function that returns an object`);const a=[],u=[],{transitionsForEvents:f,transitionsOnly:l}=(function(t){const o={},s=[];return Object.entries(t).map((([t,c])=>{if(e(c))return void s.push({routeChart:t,action:c});if(!i(c))return;const{on:a,then:u}=c;if(r(a)||n(a)){[a].flat().map((n=>{o[n]=o[n]||[],o[n].push({routeChart:t,action:u})}))}else e(u)&&s.push({routeChart:t,action:c})})),{transitionsForEvents:o,transitionsOnly:s}})(c),p=Object.entries(f).reduce((function(t,[n,e]){const{states:r,routes:o,configs:i}=k(e,O);O()&&(a.push(...r),u.push(...o));return{...t,[n]:i}}),{}),m=k(l,O),h=Object.entries(p).map((function([t,n]){return[W.increase(t),nt(t,((...e)=>{n.map((t=>({...t,args:e}))).some(d)||st(`Event not handled: "${t}"`)}))]})).concat(m.configs.map((function(t){const{fromState:n,toState:e,action:r}=t,o=`${n}->${e}`;return[V.increase(o),H(o,r)]}))).flat();if(O()){a.push(...m.states),u.push(...m.routes);const t=a.filter((t=>!E.includes(t))),n=u.filter((t=>!v.includes(t)));t.length&&S.warn(`Statebot[${s}]#${o}(): Invalid states specified:\n`+t.map((t=>`  > "${t}"`)).join("\n")),n.length&&S.warn(`Statebot[${s}]#${o}(): Invalid transitions specified:\n`+n.map((t=>`  > "${t}"`)).join("\n"))}return()=>h.map((t=>t()));function d({fromState:t,toState:n,action:r,args:o}){return X(t,(()=>(tt(n,...o),e(r)&&r(...o),!0)))}}function J(){return A[A.length-2]}function K(){return A[A.length-1]}function q(t){const n=void 0!==t?t:K(),e=y("statesAvailableFromHere",{state:r},n);if(e)throw new TypeError(e);return v.reduce(((t,e)=>{const[r,o]=e.split(g).map((t=>t.trim()));return r===n?[...t,o]:t}),[])}function Q(t,n,...r){const o=K()===t;return void 0===n?o:o?e(n)?n(...r):n:null}function X(...t){const n=y("inState",{state:[r,i]},t[0]);if(n)throw new TypeError(n);return i(t[0])?(function(t,...n){const e=Object.entries(t).find((([t])=>Q(t)));return e?Q(...e.concat(n)):null})(...t):Q(...t)}const Z=Y(((t,...n)=>{const e=y("emit",{eventName:r},t);if(e)throw new TypeError(e);return $.emit(t,...n)})),tt=Y(((t,...n)=>{const e=y("enter",{state:r},t);if(e)throw new TypeError(e);const o=K(),i=t;if(i===o)return st(`Already in state: "${i}"`),!1;if(!E.includes(i))return st(`Invalid state "${i}", not switching`),!1;const s=`${o}->${i}`;return v.includes(s)?(S.info(`${f}: tId<${++R}>: ${s}`),A.push(i),A.length>j&&A.shift(),G(_[C],i,o,...n),G(s,...n),G(_[P],i,o,...n),!0):(st(`Invalid transition "${s}", not switching`),!1)}));function nt(t,n){const o=y("onEvent",{eventName:r,cb:e},t,n);if(o)throw new TypeError(o);return $.on(t,n),()=>$.off(t,n)}const et=Object.keys(_).reduce(((t,n)=>({...t,[n]:t=>{const r=y(n,{cb:e},t);if(r)throw new TypeError(r);const o=U.increase(_[n]),i=H(_[n],t);return()=>{i(),o()}}})),{}),rt=[[x,C],[I,C],[L,P],[N,P]].reduce(((t,n)=>{const[o,i]=n,s=o.slice(2),c=s.toLowerCase();return{...t,[o]:(t,n)=>{const a=y(o,{state:r,cb:e},t,n);if(a)throw new TypeError(a);const u=[U.increase(t),U.increase(`${t}:${c}`)],f=et[i](((e,r,...o)=>{0===s.indexOf("Exit")?t===r&&n(e,...o):t===e&&n(r,...o)}));return()=>{f(),u.map((t=>t()))}}}}),{});function ot(t,...n){const e=y("Emit",{eventName:r},t);if(e)throw new TypeError(e);return(...e)=>Z(t,...n,...e)}function it(t,...n){const e=y("Enter",{state:r},t);if(e)throw new TypeError(e);return(...e)=>tt(t,...n,...e)}function st(t){const n=J(),e=K(),r=`${void 0===n?"[undefined]":n}->${e}`,o=q();o.length?S.info(`${f}: ${t}\n  > Previous transition: "${r}"\n  > From "${e}", valid states are: [${o.map((t=>`"${t}"`)).join(", ")}]`):S.info(`${f}: ${t}\n  > Previous transition: "${r}"\n  > There are no states available from "${e}"`)}function ct(t){const{description:n,table:e}=t.toValue();S.log(n),e.length?S.table(e):S.log("  > No information")}return{__STATEBOT__:1,canTransitionTo:function(...t){const n=t.flat(),e=y("canTransitionTo",{state:r},n[0]);if(e)throw new TypeError(e);if(!n.length)return!1;const o=q();return n.every((t=>o.includes(t)))},currentState:K,emit:Z,Emit:ot,enter:tt,Enter:it,history:()=>[...A],info:()=>(S.log(`${f}: Information about this state-machine`),ct(U),ct(V),void ct(W)),inspect:()=>({states:U.refs(),transitions:V.refs(),events:W.refs()}),inState:X,InState:function(...t){const n=y("InState",{state:[r,i]},t[0]);if(n)throw new TypeError(n);return i(t[0])?(function(t,...n){return(...e)=>X(t,...n,...e)})(...t):(function(t,n,...e){return(...r)=>X(t,n,...e,...r)})(...t)},name:()=>s,onEntered:rt[N],onEntering:rt[I],onEvent:nt,onExited:rt[L],onExiting:rt[x],onSwitched:et[P],onSwitching:et[C],onTransitions:t=>z(t,"onTransitions"),pause:M,paused:F,performTransitions:t=>z(t,"performTransitions"),previousState:J,reset:function(){S.warn(`${f}: State-machine reset!`),A.length=0,A.push(T)},resume:D,statesAvailableFromHere:q}},exports.assertRoute=function(t,n,e){const r=M("assertRoute",{machine:R,expectedRoute:s},t,n);if(r)throw TypeError(r);D+=1;const{description:o="Assertion complete",fromState:i="",run:c=(()=>{}),permittedDeviations:a=0,timeoutInMs:u=1e3,logLevel:p=3}=e||{},h=m(p),d=`Statebot[${t.name()}]: aId<${D}>`,g=y(n);h.log(`\n${d}: Asserting route: [${g.join(" > ")}]`),h.log(`${d}: > Assertion will start from state: "${i}"`);const $=f(c);let w=()=>{};const E=F();let v,T=F(),b=0,S=!0,O=!1;const A=[...g],j=(function(t,n){n=n||[];const e=[],r=(t=t||[]).map(((t,e)=>n[e]||"center"));let o=!1;function i(){o=!0}function s(...n){if(o)return;const r=t.reduce(((t,e,r)=>({...t,[e]:n[r]||""})),{});e.push(r)}function c(){return e.reduce(((n,e)=>t.map(((t,r)=>Math.max(e[t].length,n[r])))),t.map((()=>0)))}function a(){const n=c();function o(t,e){const o=n[e],i=r[e];return"left"===i?t.padEnd(o):"right"===i?t.padStart(o):t}return e.reduce(((n,e)=>[...n,t.reduce(((t,n,r)=>({...t,[n]:o(e[n],r)})),{})]),[])}return{lock:i,addRow:s,content:a}})(["state","expected","info","took"],["center","center","left","right"]),x=(function(t){const{revoke:n,fn:e}=l(t);let r;return function(...t){return r=e(...t),n(),r}})((t=>(I("","","","TOTAL: "+E()),j.lock(),h.log(`\n${d}: ${o}: [${t?"FAILED":"SUCCESS"}]`),h.table(j.content()),t))),{addRow:I}=j;return new Promise(((n,e)=>{if(0===A.length)return void e(x(new Error("NO ROUTE TO TEST")));const r=n=>{for(;A.length;){const e=A.shift();I(t.currentState(),`(${e})`,n),O=!1}(t=>{clearTimeout(v),w(),c(),e(t)})(x(new Error(n)))};t.inState(i)&&(S=!1,w=$());const{revoke:o,fn:s}=l((t=>{v=setTimeout((()=>{o(),r("TIMEOUT")}),u),(function(t){if(S)I(t,"-","PENDING");else{const n=A[0];n===t?(I(t,n,O?"REALIGNED":"OKAY",T()),O=!1,A.shift()):(I(t,n,"WRONG STATE",T()),O=!0,b+=1),T=F()}})(t),S&&t===i&&(S=!1,w=$()),b>a&&(o(),r("TOO MANY DEVIATIONS")),A.length<=0&&(o(),((...t)=>{clearTimeout(v),w(),c(),n(...t)})(x()))})),c=t.onSwitching(s)}))},exports.decomposeChart=b,exports.isStatebot=R,exports.routeIsPossible=function(t,n){const e=M("routeIsPossible",{machine:R,route:s},t,n);if(e)throw TypeError(e);const r=y(n);return r.every(((n,e)=>{if(e===r.length-1)return!0;{const o=r[e+1];return t.statesAvailableFromHere(n).includes(o)}}))};
