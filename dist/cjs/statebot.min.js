/*
 * Statebot
 * v2.5.1
 * https://shuckster.github.io/statebot/
 * License: MIT
 */
"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}Object.defineProperty(exports,"__esModule",{value:!0});var e=t(require("events"));function n(t){return Array.isArray(t)}function r(t){return"function"==typeof t}function o(t){return"string"==typeof t}function i(t){return"object"==typeof t}function s(t){return!(null===t||!i(t))&&Object.getPrototypeOf(t)===Object.prototype}function a(t){return!!o(t)||!!n(t)&&t.every(t=>o(t))}function c(t){return t.reduce((t,e)=>-1===t.indexOf(e)?[...t,e]:t,[])}function u(t){return(...e)=>(function(t,...e){const n=setTimeout(t,0,...e);return()=>{clearTimeout(n)}})(t,...e)}function f(t){let e,n=!1;return{fn:(...r)=>(n||(e=t(...r)),e),revoke:()=>{n=!0}}}function l(t,e,n,...r){const o=[...r].flat().reduce((t,e)=>({...t,[e]:0}),{});function i(t){const e=s(t)-1;o[t]=Math.max(e,0)}function s(t){return o[t]||0}return{increase:function(t){return o[t]=s(t)+1,()=>i(t)},decrease:i,countOf:s,toValue:function(){return{description:`Statebot[${t}]: ${n}:`,table:Object.keys(o).sort().map(t=>[t,o[t]]).map(([t,n])=>({[e]:t,refs:n||"None"}))}},refs:function(){return{...o}}}}function p(t=""){return function(e,n,...o){const i=Object.keys(n).join(", "),s=Object.entries(n).map(([t,e])=>({argName:t,argType:e})),a=o.map((t,e)=>{const{argName:n,argType:o}=s[e];if(void 0===t)return`Argument undefined: "${n}"`;let i,a,c;return r(o)?(c=!0===o(t),a=o.name,i=`${a}(${n}) did not return true`):(c=typeof t===o,a=o,i=`Argument "${n}" should be a ${a}`),c?void 0:`${i}: ${n} === ${typeof t}(${t})`}).filter(Boolean);if(a.length)return`\n${t}${e}(${i}):\n`+a.map(t=>"> "+t).join("\n")}}function h(t){let e=t;function n(){return e>=1}function r(){return e>=2}function i(){return e>=3}return o(e)&&(e={info:3,log:2,warn:1,none:0}[e]||3),{canWarn:n,canLog:r,canInfo:i,info:(...t)=>i()&&console.info(...t),table:(...t)=>r()&&console.table(...t),log:(...t)=>r()&&console.log(...t),warn:(...t)=>n()&&console.warn(...t),error:(...t)=>console.error(...t)}}const m=/[\r\n]/,d="|",g="->",$=[d,g].map(t=>t.replace("|","\\|")).join("|"),E=new RegExp(`(${$})$`),T=/[^a-z0-9!@#$%^&*:_+=<>|~.\x2D]/gi,v=/(\/\/[^\n\r]*)/,w=p("statebot.");function b(t){const e=w("decomposeRoute",{templateLiteral:a},t);if(e)throw TypeError(e);return O(S(t)).flat(2)}function y(t){const e=w("decomposeChart",{chart:a},t);if(e)throw TypeError(e);const n=O(S(t)),r=n.map(j).flat(1).map(x).flat(1);let o=!1;const i=c(r.map(t=>(t.includes("")&&(o=!0),t.join(g)))),s=c(n.flat(3));return{transitions:i.map(t=>t.split(g)),routes:i,states:o?s:s.filter(Boolean)}}function S(t){const e=(function(t){return[t].flat().reduce((t,e)=>[...t,e.split(m)],[]).flat()})(t),n=[];let r=!1;const o=e.reduce((t,e)=>{const o=e.replace(v,"").replace(T,"");return o?(r=E.test(o),r?t+o:(n.push(t+o),"")):t},"");return r||o?[...n,o]:[...n]}function O(t){return t.map(t=>t.split(g).map(t=>t.split(d)))}function j(t){const e=[];return t.reduce((t,n)=>(!1===t||e.push([t,[...n]]),[...n]),!1),e}function x([t,e]){return t.reduce((t,n)=>[...t,...e.map(t=>[n,t])],[])}const A="onExiting",I="onEntering",L="onExited",N="onEntered",P="onSwitching",_="onSwitched",k={[P]:"(ANY)state:changing",[_]:"(ANY)state:changed"};function R(t,e){const n=[],r=[];return{configs:t.reduce((t,o)=>{const{routeChart:i,action:s}=o,{states:a,routes:c,transitions:u}=y(i);return e()&&(n.push(...a),r.push(...c)),[...t,...u.map(([t,e])=>({fromState:t,toState:e,action:s}))]},[]),states:n,routes:r}}function C(t){return s(t)&&"number"==typeof t.__STATEBOT__}function D(t){return{emit:(...e)=>t.emit(...e),on:t.addListener?(...e)=>t.addListener(...e):(...e)=>t.on(...e),off:t.removeListener?(...e)=>t.removeListener(...e):(...e)=>t.off(...e)}}const M=p("statebot.");let F=0;function B(){const t=Date.now();function e(t,e){return t.toFixed(e).replace(/\.0+$/,"")}return function(){const n=Date.now()-t;return n<500?e(n)+" ms":n<5e3?e(n/1e3,2)+" s ":n<6e4?e(n/1e3,1)+" s ":e(n/1e3/60,1)+" m "}}exports.Statebot=function(t,a){if(!o(t))throw TypeError("\nStatebot: Please specify a name for this machine");const c=`Statebot[${t}]`;if(!s(a))throw TypeError(`\n${c}: Please specify options for this machine`);const{chart:u,logLevel:f=3,historyLimit:m=2}=a||{},d=void 0===a.events?new e.default:i($=a.events)&&r($.emit)&&(r($.addListener)||r($.on))&&(r($.removeListener)||r($.off))&&a.events;var $;if(!d)throw TypeError(`\n${c}: Invalid event-emitter specified in options`);const E=D(d),{states:T=[],routes:v=[]}=u?y(u):a,{startIn:w=T[0]}=a;if(!T.includes(w))throw Error(`${c}: Starting-state not in chart: "${w}"`);const b=p(c+"#"),S=h(f),{canWarn:O}=S,j=[w],x=Math.max(m,2),C=D(new e.default);let M=0;const{pause:F,resume:B,paused:Y,Pausable:G}=(function(t=!1,e=(()=>{})){let n=!!t;return{Pausable:function(t){return(...r)=>n?(e(),!1):t(...r)},paused:()=>n,pause:()=>{n=!0},resume:()=>{n=!1}}})(!1,()=>S.warn(c+": Ignoring callback, paused")),H=G((t,...e)=>C.emit(t,e));function U(t,e){const n=t=>e(...t);return C.on(t,n),()=>C.off(t,n)}const V=l(t,"states","Listening for the following state-changes",[...T]),W=l(t,"transitions","Listening for the following transitions",[...v]),q=l(t,"events","Listening for the following events"),z=({fromState:t,toState:e,action:n,args:o})=>Z(t,()=>(et(e,...o),r(n)&&n(...o),!0));function K(e,i){const a=r(e)?e({enter:et,emit:tt,Enter:st,Emit:it}):s(e)?e:null;if(!s(a))throw TypeError(`Statebot[${t}]#${i}(): Expected an object, or a function that returns an object`);const c={},u=[];Object.entries(a).map(([t,e])=>{if(r(e))u.push({routeChart:t,action:e});else if(!s(e))return;const{on:i,then:a}=e;if(o(i)||n(i)){[i].flat().map(e=>{c[e]=c[e]||[],c[e].push({routeChart:t,action:a})})}else r(a)&&u.push({routeChart:t,action:e})});const f=[],l=[],p=[],h=Object.entries(c).reduce((t,[e,n])=>{const{states:r,routes:o,configs:i}=R(n,O);return O()&&(f.push(...r),l.push(...o)),{...t,[e]:i}},{});p.push(...Object.entries(h).map(([t,e])=>[q.increase(t),nt(t,(...n)=>{e.map(t=>({...t,args:n})).some(z)||at(`Event not handled: "${t}"`)})]).flat());const m=R(u,O);if(O()&&(f.push(...m.states),l.push(...m.routes)),p.push(...m.configs.map(t=>{const{fromState:e,toState:n,action:r}=t,o=`${e}->${n}`;return[W.increase(o),U(o,r)]}).flat()),O()){const e=f.filter(t=>!T.includes(t)),n=l.filter(t=>!v.includes(t));e.length&&S.warn(`Statebot[${t}]#${i}(): Invalid states specified:\n`+e.map(t=>`  > "${t}"`).join("\n")),n.length&&S.warn(`Statebot[${t}]#${i}(): Invalid transitions specified:\n`+n.map(t=>`  > "${t}"`).join("\n"))}return()=>p.map(t=>t())}function J(){return j[j.length-2]}function Q(){return j[j.length-1]}function X(t){const e=void 0!==t?t:Q(),n=b("statesAvailableFromHere",{state:o},e);if(n)throw TypeError(n);return v.reduce((t,n)=>{const[r,o]=n.split(g).map(t=>t.trim());return r===e?[...t,o]:t},[])}function Z(t,e,...n){const i=b("inState",{state:o},t);if(i)throw TypeError(i);const s=Q()===t;return void 0===e?s:s?r(e)?e(...n):e:null}const tt=G((t,...e)=>{const n=b("emit",{eventName:o},t);if(n)throw TypeError(n);return E.emit(t,...e)}),et=G((t,...e)=>{const n=b("enter",{state:o},t);if(n)throw TypeError(n);const r=Q(),i=t;if(i===r)return at(`Already in state: "${i}"`),!1;if(!T.includes(i))return at(`Invalid state "${i}", not switching`),!1;const s=`${r}->${i}`;return v.includes(s)?(S.info(`${c}: tId<${++M}>: ${s}`),j.push(i),j.length>x&&j.shift(),H(k[P],i,r,...e),H(s,...e),H(k[_],i,r,...e),!0):(at(`Invalid transition "${s}", not switching`),!1)});function nt(t,e){const n=b("onEvent",{eventName:o,cb:r},t,e);if(n)throw TypeError(n);return E.on(t,e),()=>E.off(t,e)}const rt=Object.keys(k).reduce((t,e)=>({...t,[e]:t=>{const n=b(e,{cb:r},t);if(n)throw TypeError(n);const o=V.increase(k[e]),i=U(k[e],t);return()=>{i(),o()}}}),{}),ot=[[A,P],[I,P],[L,_],[N,_]].reduce((t,e)=>{const[n,i]=e,s=n.slice(2),a=s.toLowerCase();return{...t,[n]:(t,e)=>{const c=b(n,{state:o,cb:r},t,e);if(c)throw TypeError(c);const u=[V.increase(t),V.increase(`${t}:${a}`)],f=rt[i]((n,r,...o)=>{0===s.indexOf("Exit")?t===r&&e(n,...o):t===n&&e(r,...o)});return()=>{f(),u.map(t=>t())}}}},{});function it(t,...e){const n=b("Emit",{eventName:o},t);if(n)throw TypeError(n);return(...n)=>tt(t,...e,...n)}function st(t,...e){const n=b("Enter",{state:o},t);if(n)throw TypeError(n);return(...n)=>et(t,...e,...n)}function at(t){const e=J(),n=Q(),r=`${void 0===e?"[undefined]":e}->${n}`,o=X();o.length?S.info(`${c}: ${t}\n  > Previous transition: "${r}"\n  > From "${n}", valid states are: [${o.map(t=>`"${t}"`).join(", ")}]`):S.info(`${c}: ${t}\n  > Previous transition: "${r}"\n  > There are no states available from "${n}"`)}function ct(t){const{description:e,table:n}=t.toValue();S.log(e),n.length?S.table(n):S.log("  > No information")}return{__STATEBOT__:1,canTransitionTo:function(...t){const e=t.flat(),n=b("canTransitionTo",{state:o},e[0]);if(n)throw TypeError(n);if(!e.length)return!1;const r=X();return e.every(t=>r.includes(t))},currentState:Q,emit:tt,Emit:it,enter:et,Enter:st,history:()=>[...j],info:()=>(S.log(c+": Information about this state-machine"),ct(V),ct(W),void ct(q)),inspect:()=>({states:V.refs(),transitions:W.refs(),events:q.refs()}),inState:Z,InState:function(t,e,...n){const r=b("InState",{state:o},t);if(r)throw TypeError(r);return(...r)=>Z(t,e,...n,...r)},name:()=>t,onEntered:ot[N],onEntering:ot[I],onEvent:nt,onExited:ot[L],onExiting:ot[A],onSwitched:rt[_],onSwitching:rt[P],onTransitions:t=>K(t,"onTransitions"),pause:F,paused:Y,performTransitions:t=>K(t,"performTransitions"),previousState:J,reset:function(){S.warn(c+": State-machine reset!"),j.length=0,j.push(w)},resume:B,statesAvailableFromHere:X}},exports.assertRoute=function(t,e,n){const r=M("assertRoute",{machine:C,expectedRoute:a},t,e);if(r)throw TypeError(r);F+=1;const{description:o="Assertion complete",fromState:i="",run:s=(()=>{}),permittedDeviations:c=0,timeoutInMs:l=1e3,logLevel:p=3}=n||{},m=h(p),d=`Statebot[${t.name()}]: aId<${F}>`,g=b(e);m.log(`\n${d}: Asserting route: [${g.join(" > ")}]`),m.log(`${d}: > Assertion will start from state: "${i}"`);const $=u(s);let E=()=>{};const T=B();let v,w=B(),y=0,S=!0,O=!1;const j=[...g],x=(function(t=[],e=[]){const n=[],r=t.map((t,n)=>e[n]||"center");let o=!1;function i(){o=!0}function s(...e){if(o)return;const r=t.reduce((t,n,r)=>({...t,[n]:e[r]||""}),{});n.push(r)}function a(){return n.reduce((e,n)=>t.map((t,r)=>Math.max(n[t].length,e[r])),t.map(()=>0))}function c(t,e){return t+" ".repeat(e-t.length)}function u(t,e){return" ".repeat(e-t.length)+t}function f(){const e=a();function o(t,n){const o=e[n],i=r[n];return"left"===i?c(t,o):"right"===i?u(t,o):t}return n.reduce((e,n)=>[...e,t.reduce((t,e,r)=>({...t,[e]:o(n[e],r)}),{})],[])}return{lock:i,addRow:s,content:f}})(["state","expected","info","took"],["center","center","left","right"]),A=(function(t){const{revoke:e,fn:n}=f(t);let r;return function(...t){return r=n(...t),e(),r}})(t=>(I("","","","TOTAL: "+T()),x.lock(),m.log(`\n${d}: ${o}: [${t?"FAILED":"SUCCESS"}]`),m.table(x.content()),t)),{addRow:I}=x;return new Promise((e,n)=>{if(0===j.length)return void n(A(new Error("NO ROUTE TO TEST")));const r=e=>{for(;j.length;){const n=j.shift();I(t.currentState(),`(${n})`,e),O=!1}(t=>{clearTimeout(v),E(),a(),n(t)})(A(new Error(e)))};t.inState(i)&&(S=!1,E=$());const{revoke:o,fn:s}=f(t=>{v=setTimeout(()=>{o(),r("TIMEOUT")},l),(function(t){if(S)I(t,"-","PENDING");else{const e=j[0];e===t?(I(t,e,O?"REALIGNED":"OKAY",w()),O=!1,j.shift()):(I(t,e,"WRONG STATE",w()),O=!0,y+=1),w=B()}})(t),S&&t===i&&(S=!1,E=$()),y>c&&(o(),r("TOO MANY DEVIATIONS")),j.length<=0&&(o(),((...t)=>{clearTimeout(v),E(),a(),e(...t)})(A()))}),a=t.onSwitching(s)})},exports.decomposeChart=y,exports.isStatebot=C,exports.routeIsPossible=function(t,e){const n=M("routeIsPossible",{machine:C,route:a},t,e);if(n)throw TypeError(n);const r=b(e);return r.every((e,n)=>{if(n===r.length-1)return!0;{const o=r[n+1];return t.statesAvailableFromHere(e).includes(o)}})};
