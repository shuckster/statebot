/*
 * Statebot
 * v2.2.0
 * https://shuckster.github.io/statebot/
 * License: ISC
 */
!(function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((t=t||self).statebot={})})(this,(function(t){"use strict";function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function e(t,n,e){return n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e,t}function r(t,n){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable}))),e.push.apply(e,r)}return e}function o(t){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?r(Object(o),!0).forEach((function(n){e(t,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(o,n))}))}return t}function i(t,n){return(function(t){if(Array.isArray(t))return t})(t)||(function(t,n){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var e=[],r=!0,o=!1,i=void 0;try{for(var a,c=t[Symbol.iterator]();!(r=(a=c.next()).done)&&(e.push(a.value),!n||e.length!==n);r=!0);}catch(t){o=!0,i=t}finally{try{r||null==c.return||c.return()}finally{if(o)throw i}}return e})(t,n)||c(t,n)||(function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")})()}function a(t){return(function(t){if(Array.isArray(t))return u(t)})(t)||(function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)})(t)||c(t)||(function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")})()}function c(t,n){if(t){if("string"==typeof t)return u(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?u(t,n):void 0}}function u(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=new Array(n);e<n;e++)r[e]=t[e];return r}function s(){}function f(){f.init.call(this)}function l(t){return void 0===t._maxListeners?f.defaultMaxListeners:t._maxListeners}function p(t,n,e){if(n)t.call(e);else for(var r=t.length,o=b(t,r),i=0;i<r;++i)o[i].call(e)}function v(t,n,e,r){if(n)t.call(e,r);else for(var o=t.length,i=b(t,o),a=0;a<o;++a)i[a].call(e,r)}function h(t,n,e,r,o){if(n)t.call(e,r,o);else for(var i=t.length,a=b(t,i),c=0;c<i;++c)a[c].call(e,r,o)}function d(t,n,e,r,o,i){if(n)t.call(e,r,o,i);else for(var a=t.length,c=b(t,a),u=0;u<a;++u)c[u].call(e,r,o,i)}function y(t,n,e,r){if(n)t.apply(e,r);else for(var o=t.length,i=b(t,o),a=0;a<o;++a)i[a].apply(e,r)}function m(t,n,e,r){var o,i,a,c;if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');if((i=t._events)?(i.newListener&&(t.emit("newListener",n,e.listener?e.listener:e),i=t._events),a=i[n]):(i=t._events=new s,t._eventsCount=0),a){if("function"==typeof a?a=i[n]=r?[e,a]:[a,e]:r?a.unshift(e):a.push(e),!a.warned&&(o=l(t))&&o>0&&a.length>o){a.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+n+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=t,u.type=n,u.count=a.length,c=u,"function"==typeof console.warn?console.warn(c):console.log(c)}}else a=i[n]=e,++t._eventsCount;return t}function g(t,n,e){var r=!1;function o(){t.removeListener(n,o),r||(r=!0,e.apply(t,arguments))}return o.listener=e,o}function w(t){var n=this._events;if(n){var e=n[t];if("function"==typeof e)return 1;if(e)return e.length}return 0}function b(t,n){for(var e=new Array(n);n--;)e[n]=t[n];return e}s.prototype=Object.create(null),f.EventEmitter=f,f.usingDomains=!1,f.prototype.domain=void 0,f.prototype._events=void 0,f.prototype._maxListeners=void 0,f.defaultMaxListeners=10,f.init=function(){this.domain=null,f.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new s,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},f.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=t,this},f.prototype.getMaxListeners=function(){return l(this)},f.prototype.emit=function(t){var n,e,r,o,i,a,c,u="error"===t;if(a=this._events)u=u&&null==a.error;else if(!u)return!1;if(c=this.domain,u){if(n=arguments[1],!c){if(n instanceof Error)throw n;var s=new Error('Uncaught, unspecified "error" event. ('+n+")");throw s.context=n,s}return n||(n=new Error('Uncaught, unspecified "error" event')),n.domainEmitter=this,n.domain=c,n.domainThrown=!1,c.emit("error",n),!1}if(!(e=a[t]))return!1;var f="function"==typeof e;switch(r=arguments.length){case 1:p(e,f,this);break;case 2:v(e,f,this,arguments[1]);break;case 3:h(e,f,this,arguments[1],arguments[2]);break;case 4:d(e,f,this,arguments[1],arguments[2],arguments[3]);break;default:for(o=new Array(r-1),i=1;i<r;i++)o[i-1]=arguments[i];y(e,f,this,o)}return!0},f.prototype.addListener=function(t,n){return m(this,t,n,!1)},f.prototype.on=f.prototype.addListener,f.prototype.prependListener=function(t,n){return m(this,t,n,!0)},f.prototype.once=function(t,n){if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');return this.on(t,g(this,t,n)),this},f.prototype.prependOnceListener=function(t,n){if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');return this.prependListener(t,g(this,t,n)),this},f.prototype.removeListener=function(t,n){var e,r,o,i,a;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(e=r[t]))return this;if(e===n||e.listener&&e.listener===n)0==--this._eventsCount?this._events=new s:(delete r[t],r.removeListener&&this.emit("removeListener",t,e.listener||n));else if("function"!=typeof e){for(o=-1,i=e.length;i-- >0;)if(e[i]===n||e[i].listener&&e[i].listener===n){a=e[i].listener,o=i;break}if(o<0)return this;if(1===e.length){if(e[0]=void 0,0==--this._eventsCount)return this._events=new s,this;delete r[t]}else!(function(t,n){for(var e=n,r=e+1,o=t.length;r<o;e+=1,r+=1)t[e]=t[r];t.pop()})(e,o);r.removeListener&&this.emit("removeListener",t,a||n)}return this},f.prototype.removeAllListeners=function(t){var n,e;if(!(e=this._events))return this;if(!e.removeListener)return 0===arguments.length?(this._events=new s,this._eventsCount=0):e[t]&&(0==--this._eventsCount?this._events=new s:delete e[t]),this;if(0===arguments.length){for(var r,o=Object.keys(e),i=0;i<o.length;++i)"removeListener"!==(r=o[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new s,this._eventsCount=0,this}if("function"==typeof(n=e[t]))this.removeListener(t,n);else if(n)do{this.removeListener(t,n[n.length-1])}while(n[0]);return this},f.prototype.listeners=function(t){var n,e=this._events;return e&&(n=e[t])?"function"==typeof n?[n.listener||n]:(function(t){for(var n=new Array(t.length),e=0;e<n.length;++e)n[e]=t[e].listener||t[e];return n})(n):[]},f.listenerCount=function(t,n){return"function"==typeof t.listenerCount?t.listenerCount(n):w.call(t,n)},f.prototype.listenerCount=w,f.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var E=k,S=function(t){return M(t)&&R(t.emit)&&R(t.addListener)&&R(t.removeListener)},T=R,A=function(t){if(null===t||!M(t))return!1;return Object.getPrototypeOf(t)===Object.prototype},O=D,L=function(t){if(D(t))return!0;if(k(t))return t.every((function(t){return D(t)}));return!1},_=function(t){return t.reduce((function(t,n){return-1===t.indexOf(n)?[].concat(a(t),[n]):t}),[])},j=function(t){return function(){for(var n=arguments.length,e=new Array(n),r=0;r<n;r++)e[r]=arguments[r];return U.apply(void 0,[t].concat(e))}},x=function(t){var n,e=F(t),r=e.revoke,o=e.fn;return function(){return n=o.apply(void 0,arguments),r(),n}},C=F,I=function(t,n,r){for(var a={},c=arguments.length,u=new Array(c>3?c-3:0),s=3;s<c;s++)u[s-3]=arguments[s];function f(t){return a[t]=p(t)+1,function(){return l(t)}}function l(t){var n=p(t)-1;a[t]=Math.max(n,0)}function p(t){return a[t]||0}function v(){return o({},a)}function h(){return Object.keys(a).sort().map((function(t){return[t,a[t]]})).map((function(t){var r,o=i(t,2),a=o[0],c=o[1];return e(r={},n,a),e(r,"refs",c||"None"),r}))}function d(){return{description:"Statebot[".concat(t,"]: ").concat(r,":"),table:h()}}return[].concat(u).flat().forEach((function(t){a[t]=0})),{increase:f,decrease:l,countOf:p,toValue:d,refs:v}},P=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return function(e,r){for(var o=Object.entries(r).map((function(t){var n=i(t,2);return{argName:n[0],argType:n[1]}})),a=Object.keys(r).join(", "),c=arguments.length,u=new Array(c>2?c-2:0),s=2;s<c;s++)u[s-2]=arguments[s];var f=u.map((function(t,e){var r,i,a,c=o[e],u=c.argName,s=c.argType;return void 0===t?'Argument undefined: "'.concat(u,'"'):(R(s)?(a=!0===s(t),i=s.name,r="".concat(i,"(").concat(u,") did not return true")):(a=n(t)===s,i=s,r='Argument "'.concat(u,'" should be a ').concat(i)),a?void 0:"".concat(r,": ").concat(u," === ").concat(n(t),"(").concat(t,")"))})).filter(Boolean);return f.length?"\n".concat(t).concat(e,"(").concat(a,"):\n")+"".concat(f.map((function(t){return"> ".concat(t)})).join("\n")):void 0}},N=function(t){var n=t;D(n)&&(n={info:3,log:2,warn:1,none:0}[n]||3);function e(){return n>=1}function r(){return n>=2}function o(){return n>=3}return{canWarn:e,canLog:r,canInfo:o,info:function(){var t;return o()&&(t=console).info.apply(t,arguments)},table:function(){var t;return r()&&(t=console).table.apply(t,arguments)},log:function(){var t;return r()&&(t=console).log.apply(t,arguments)},warn:function(){var t;return e()&&(t=console).warn.apply(t,arguments)},error:function(){var t;return(t=console).error.apply(t,arguments)}}};function k(t){return Array.isArray(t)}function R(t){return"function"==typeof t}function D(t){return"string"==typeof t}function M(t){return"object"===n(t)}function U(t){for(var n=arguments.length,e=new Array(n>1?n-1:0),r=1;r<n;r++)e[r-1]=arguments[r];var o=setTimeout.apply(void 0,[t,0].concat(e));return function(){clearTimeout(o)}}function F(t){var n,e=!1;return{fn:function(){return e||(n=t.apply(void 0,arguments)),n},revoke:function(){e=!0}}}var W=/[\r\n]/,Y="|",$="->",B=[Y,$].map((function(t){return t.replace("|","\\|")})).join("|"),G=new RegExp("(".concat(B,")$")),H=/[^a-z0-9!@#$%^&*:_+=<>|~.\x2D]/gi,V=/(\/\/[^\n\r]*)/,K={cxPipe:Y,cxArrow:$,rxDisallowedCharacters:H,decomposeChart:function(t){var n=J("decomposeChart",{templateLiteral:q},t);if(n)throw TypeError(n);var e=X(Q(t)).map(Z).flat(1).map(tt).flat(1),r=[],o=e.map((function(t){return r.push.apply(r,a(t)),t.join($)})),i=z(o),c=z(r);return{transitions:i.map((function(t){return t.split($)})),routes:i,states:c}},decomposeRoute:function(t){var n=J("decomposeRoute",{templateLiteral:q},t);if(n)throw TypeError(n);return X(Q(t)).flat(2)}},z=_,q=L,J=P("statebot.");function Q(t){var n=(function(t){return[t].flat().reduce((function(t,n){return[].concat(a(t),[n.split(W)])}),[]).flat()})(t),e=[];return n.reduce((function(t,n){var r=n.replace(V,"").replace(H,"");return r?G.test(r)?t+r:(e.push(t+r),""):t}),""),e}function X(t){return t.map((function(t){return t.split($).map((function(t){return t.split(Y)}))}))}function Z(t){var n=[];return t.reduce((function(t,e){return!1===t||n.push([t,a(e)]),a(e)}),!1),n}function tt(t){var n=i(t,2),e=n[0],r=n[1];return e.reduce((function(t,n){return[].concat(a(t),a(r.map((function(t){return[n,t]}))))}),[])}var nt=function(t,n){if(!ct(t))throw TypeError("\nStatebot: Please specify a name for this machine");var r="Statebot[".concat(t,"]");if(!at(n))throw TypeError("\n".concat(r,": Please specify options for this machine"));var c=n||{},u=c.chart,s=void 0===u?void 0:u,l=c.logLevel,p=void 0===l?3:l,v=c.historyLimit,h=void 0===v?2:v,d=ut("".concat(r,"#")),y=st(p),m=y.canWarn,g=s?lt(s):n,w=g.states,b=void 0===w?[]:w,E=g.routes,S=void 0===E?[]:E,T=n.startIn,A=void 0===T?b[0]:T;if(!b.includes(A))throw Error("".concat(r,': Starting-state not in chart: "').concat(A,'"'));var O=0,L=[A],_=Math.max(h,2),j=ot(n.events)?n.events:new f,x=new f,C={onSwitching:"(ANY)state:changing",onSwitched:"(ANY)state:changed"};function I(t){for(var n=arguments.length,e=new Array(n>1?n-1:0),r=1;r<n;r++)e[r-1]=arguments[r];return x.emit.apply(x,[t].concat(e))}function P(t,n){return x.addListener(t,n),function(){x.removeListener(t,n)}}var N=ft(t,"states","Listening for the following state-changes",a(b)),k=ft(t,"transitions","Listening for the following transitions",a(S)),R=ft(t,"events","Listening for the following events");function D(n,r){var c=it(n)?n({enter:$,emit:Y,Enter:K,Emit:V}):at(n)?n:null;if(!at(c))throw TypeError("Statebot[".concat(t,"]#").concat(r,"(): Expected an object, or a function that returns an object"));var u={},s=[];Object.entries(c).forEach((function(t){var n=i(t,2),e=n[0],r=n[1];if(it(r))s.push({routeChart:e,action:r});else if(!at(r))return;var o=r.on,a=r.then;ct(o)||rt(o)?[o].flat().forEach((function(t){u[t]=u[t]||[],u[t].push({routeChart:e,action:a})})):it(a)&&s.push({routeChart:e,action:r})}));var f=[],l=[],p=Object.entries(u).reduce((function(t,n){var r=i(n,2),c=r[0],u=vt(r[1],m),s=u.states,p=u.routes,v=u.configs;return m()&&(f.push.apply(f,a(s)),l.push.apply(l,a(p))),o(o({},t),{},e({},c,v))}),{}),v=[];v.push.apply(v,a(Object.entries(p).map((function(t){var n=i(t,2),e=n[0],r=n[1];return[R.increase(e),B(e,(function(){for(var t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];var i=r.some((function(t){var e=t.fromState,r=t.toState,o=t.action;return!!W(e,(function(){return $.apply(void 0,[r].concat(n)),it(o)&&o.apply(void 0,n),!0}))}));i||z('Event not handled: "'.concat(e,'"'))}))]})).flat()));var h=vt(s,m);if(m()&&(f.push.apply(f,a(h.states)),l.push.apply(l,a(h.routes))),v.push.apply(v,a(h.configs.map((function(t){var n=t.fromState,e=t.toState,r=t.action,o="".concat(n,"->").concat(e);return[k.increase(o),P(o,r)]})).flat())),m()){var d=f.filter((function(t){return!b.includes(t)})),g=l.filter((function(t){return!S.includes(t)}));d.length&&y.warn("Statebot[".concat(t,"]#").concat(r,"(): Invalid states specified:\n")+d.map((function(t){return'  > "'.concat(t,'"')})).join("\n")),g.length&&y.warn("Statebot[".concat(t,"]#").concat(r,"(): Invalid transitions specified:\n")+g.map((function(t){return'  > "'.concat(t,'"')})).join("\n"))}return function(){return v.forEach((function(t){return t()}))}}function M(){return L[L.length-2]}function U(){return L[L.length-1]}function F(t){var n=void 0!==t?t:U(),e=d("statesAvailableFromHere",{state:ct},n);if(e)throw TypeError(e);return S.reduce((function(t,e){var r=i(e.split(pt).map((function(t){return t.trim()})),2),o=r[0],c=r[1];return o===n?[].concat(a(t),[c]):t}),[])}function W(t,n){var e=d("inState",{state:ct},t);if(e)throw TypeError(e);var r=U()===t;if(void 0!==n){if(!r)return null;if(it(n)){for(var o=arguments.length,i=new Array(o>2?o-2:0),a=2;a<o;a++)i[a-2]=arguments[a];return n.apply(void 0,i)}return n}return r}function Y(t){var n=d("emit",{eventName:ct},t);if(n)throw TypeError(n);for(var e=arguments.length,r=new Array(e>1?e-1:0),o=1;o<e;o++)r[o-1]=arguments[o];return j.emit.apply(j,[t].concat(r))}function $(t){var n=d("enter",{state:ct},t);if(n)throw TypeError(n);var e=U(),o=t;if(o===e)return z('Already in state: "'.concat(o,'"')),!1;if(!b.includes(o))return z('Invalid state "'.concat(o,'", not switching')),!1;var i="".concat(e,"->").concat(o);if(!S.includes(i))return z('Invalid transition "'.concat(i,'", not switching')),!1;y.info("".concat(r,": tId<").concat(++O,">: ").concat(i)),L.push(o),L.length>_&&L.shift();for(var a=arguments.length,c=new Array(a>1?a-1:0),u=1;u<a;u++)c[u-1]=arguments[u];return I.apply(void 0,[C.onSwitching,o,e].concat(c)),I.apply(void 0,[i].concat(c)),I.apply(void 0,[C.onSwitched,o,e].concat(c)),!0}function B(t,n){var e=d("onEvent",{eventName:ct,cb:it},t,n);if(e)throw TypeError(e);return j.addListener(t,n),function(){return j.removeListener(t,n)}}var G=Object.keys(C).reduce((function(t,n){return o(o({},t),{},e({},n,(function(t){var e=d(n,{cb:it},t);if(e)throw TypeError(e);var r=N.increase(C[n]),o=P(C[n],(function(n,e){for(var r=arguments.length,o=new Array(r>2?r-2:0),i=2;i<r;i++)o[i-2]=arguments[i];t.apply(void 0,[n,e].concat(o))}));return function(){o(),r()}})))}),{}),H=[["Exiting","onSwitching"],["Entering","onSwitching"],["Exited","onSwitched"],["Entered","onSwitched"]].reduce((function(t,n){var r=i(n,2),a=r[0],c=r[1],u="on".concat(a),s=a.toLowerCase();return o(o({},t),{},e({},u,(function(t,n){var e=d(u,{state:ct,cb:it},t,n);if(e)throw TypeError(e);var r=[N.increase(t),N.increase("".concat(t,":").concat(s))],o=G[c]((function(e,r){for(var o=arguments.length,i=new Array(o>2?o-2:0),c=2;c<o;c++)i[c-2]=arguments[c];0===a.indexOf("Exit")?t===r&&n.apply(void 0,[e].concat(i)):t===e&&n.apply(void 0,[r].concat(i))}));return function(){o(),r.map((function(t){return t()}))}})))}),{});function V(t){var n=d("Emit",{eventName:ct},t);if(n)throw TypeError(n);return function(){for(var n=arguments.length,e=new Array(n),r=0;r<n;r++)e[r]=arguments[r];return Y.apply(void 0,[t].concat(e))}}function K(t){var n=d("Enter",{state:ct},t);if(n)throw TypeError(n);return function(){for(var n=arguments.length,e=new Array(n),r=0;r<n;r++)e[r]=arguments[r];return $.apply(void 0,[t].concat(e))}}function z(t){var n=M(),e=U(),o="".concat(void 0===n?"[undefined]":n,"->").concat(e),i=F();i.length?y.info("".concat(r,": ").concat(t,"\n")+'  > Previous transition: "'.concat(o,'"\n')+'  > From "'.concat(e,'", valid states are: [').concat(i.map((function(t){return'"'.concat(t,'"')})).join(", "),"]")):y.info("".concat(r,": ").concat(t,"\n")+'  > Previous transition: "'.concat(o,'"\n')+'  > There are no states available from "'.concat(e,'"'))}function q(t){var n=t.toValue(),e=n.description,r=n.table;y.log(e),r.length?y.table(r):y.log("  > No information")}return{__STATEBOT__:1,canTransitionTo:function(){for(var t=arguments.length,n=new Array(t),e=0;e<t;e++)n[e]=arguments[e];var r=n.flat(),o=d("canTransitionTo",{state:ct},r[0]);if(o)throw TypeError(o);if(!r.length)return!1;var i=F();return r.every((function(t){return i.includes(t)}))},currentState:U,emit:Y,Emit:V,enter:$,Enter:K,history:function(){return[].concat(L)},info:function(){return y.log("".concat(r,": Information about this state-machine")),q(N),q(k),void q(R)},inspect:function(){return{states:N.refs(),transitions:k.refs(),events:R.refs()}},inState:W,InState:function(t,n){var e=d("InState",{state:ct},t);if(e)throw TypeError(e);return function(){for(var e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];return W.apply(void 0,[t,n].concat(r))}},name:function(){return t},onEntered:H.onEntered,onEntering:H.onEntering,onEvent:B,onExited:H.onExited,onExiting:H.onExiting,onSwitched:G.onSwitched,onSwitching:G.onSwitching,onTransitions:function(t){return D(t,"onTransitions")},performTransitions:function(t){return D(t,"performTransitions")},previousState:M,reset:function(){y.warn("".concat(r,": State-machine reset!")),L.length=0,L.push(A)},statesAvailableFromHere:F}},et=function(t){return at(t)&&"number"==typeof t.__STATEBOT__},rt=E,ot=S,it=T,at=A,ct=O,ut=P,st=N,ft=I,lt=K.decomposeChart,pt=K.cxArrow;function vt(t,n){var e=[],r=[];return{configs:t.reduce((function(t,o){var c=o.routeChart,u=o.action,s=lt(c),f=s.states,l=s.routes,p=s.transitions;return n()&&(e.push.apply(e,a(f)),r.push.apply(r,a(l))),[].concat(a(t),a(p.map((function(t){var n=i(t,2);return{fromState:n[0],toState:n[1],action:u}}))))}),[]),states:e,routes:r}}var ht=function(t,n){var e=Tt("routeIsPossible",{machine:yt,expectedRoute:St},t,n);if(e)throw TypeError(e);var r=mt(n);return r.every((function(n,e){if(e===r.length-1)return!0;var o=r[e+1];return t.statesAvailableFromHere(n).includes(o)}))},dt=function(t,n,r){var i=Tt("assertRoute",{machine:yt,expectedRoute:St},t,n);if(i)throw TypeError(i);At+=1;var c=r||{},u=c.description,s=void 0===u?"Assertion complete":u,f=c.fromState,l=void 0===f?"":f,p=c.run,v=void 0===p?function(){}:p,h=c.permittedDeviations,d=void 0===h?0:h,y=c.timeoutInMs,m=void 0===y?1e3:y,g=c.logLevel,w=Et(void 0===g?3:g),b="Statebot[".concat(t.name(),"]: aId<").concat(At,">"),E=mt(n);w.log("\n".concat(b,": Asserting route: [").concat(E.join(" > "),"]")),w.log("".concat(b,': > Assertion will start from state: "').concat(l,'"'));var S,T=gt(v),A=function(){},O=Ot(),L=Ot(),_=0,j=!0,x=!1,C=a(E),I=(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=[],i=t.map((function(t,e){return n[e]||"center"})),c=!1;function u(){c=!0}function s(){for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];if(!c){var u=t.reduce((function(t,n,r){var a=i[r]||"";return o(o({},t),{},e({},n,a))}),{});r.push(u)}}function f(){return r.reduce((function(n,e){return t.map((function(t,r){return Math.max(e[t].length,n[r])}))}),t.map((function(){return 0})))}function l(t,n){return t+" ".repeat(n-t.length)}function p(t,n){return" ".repeat(n-t.length)+t}function v(){var n=f();return r.reduce((function(r,c){var u=t.reduce((function(t,r,a){return o(o({},t),{},e({},r,(function(t,e){var r=n[e],o=i[e];return"left"===o?l(t,r):"right"===o?p(t,r):t})(c[r],a)))}),{});return[].concat(a(r),[u])}),[])}return{lock:u,addRow:s,content:v}})(["state","expected","info","took"],["center","center","left","right"]),P=wt((function(t){return N("","","","TOTAL: "+O()),I.lock(),w.log("\n".concat(b,": ").concat(s,": [").concat(t?"FAILED":"SUCCESS","]")),w.table(I.content()),t})),N=I.addRow;return new Promise((function(n,e){if(0!==C.length){var r=function(n){for(;C.length;){var r=C.shift();N(t.currentState(),"(".concat(r,")"),n),x=!1}!(function(t){clearTimeout(S),A(),c(),e(t)})(P(new Error(n)))};t.inState(l)&&(j=!1,A=T());var o=bt((function(t){S=setTimeout((function(){i(),r("TIMEOUT")}),m),(function(t){if(j)N(t,"-","PENDING");else{var n=C[0];n===t?(N(t,n,x?"REALIGNED":"OKAY",L()),x=!1,C.shift()):(N(t,n,"WRONG STATE",L()),x=!0,_+=1),L=Ot()}})(t),j&&t===l&&(j=!1,A=T()),_>d&&(i(),r("TOO MANY DEVIATIONS")),C.length<=0&&(i(),(function(){clearTimeout(S),A(),c(),n.apply(void 0,arguments)})(P()))})),i=o.revoke,a=o.fn,c=t.onSwitching(a)}else e(P(new Error("NO ROUTE TO TEST")))}))},yt=et,mt=K.decomposeRoute,gt=j,wt=x,bt=C,Et=N,St=L,Tt=P("statebot.");var At=0;function Ot(){var t=Date.now();function n(t,n){return t.toFixed(n).replace(/\.0+$/,"")}return function(){var e=Date.now()-t;return e<500?"".concat(n(e)," ms"):e<5e3?"".concat(n(e/1e3,2)," s "):e<6e4?"".concat(n(e/1e3,1)," s "):"".concat(n(e/1e3/60,1)," m ")}}var Lt={Statebot:nt,isStatebot:et,routeIsPossible:ht,assertRoute:dt,decomposeChart:K.decomposeChart},_t=Lt.Statebot,jt=Lt.isStatebot,xt=Lt.routeIsPossible,Ct=Lt.assertRoute,It=Lt.decomposeChart;t.Statebot=_t,t.assertRoute=Ct,t.decomposeChart=It,t.default=Lt,t.isStatebot=jt,t.routeIsPossible=xt,Object.defineProperty(t,"__esModule",{value:!0})}));
